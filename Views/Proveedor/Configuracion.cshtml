@{
    ViewData["Title"] = "Configuraci√≥n - Zooni";
    Layout = null;
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --verde: #3ac37d;
            --verde-hover: #2ea968;
            --gris: #555;
            --gris-claro: #ccc;
            --marron: #8B5E3C;
            --fondo: #fff;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        header {
            background-color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: var(--marron);
            margin: 0;
            font-size: 24px;
        }

        .btn-volver {
            background-color: var(--gris-claro);
            color: var(--gris);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-volver:hover {
            background-color: #bbb;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        .contenedor {
            background: white;
            border-radius: 5px;
            padding: 2.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .titulo-principal {
            text-align: center;
            margin-bottom: 2rem;
        }

        .titulo-principal h2 {
            color: var(--marron);
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
        }

        .formulario {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .campo-grupo {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .label-text {
            color: var(--gris);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            text-align: left;
            width: 100%;
        }

        .required {
            color: red;
            margin-left: 2px;
        }

        input, textarea {
            width: 100%;
            padding: 13px 16px;
            margin-bottom: 8px;
            border-radius: 5px;
            border: 1.8px solid var(--gris-claro);
            outline: none;
            font-size: 15px;
            text-align: left;
            transition: border 0.2s ease, box-shadow 0.2s ease;
            background: #fff;
            font-family: 'Poppins', sans-serif;
        }

        input[type="number"] {
            text-align: center;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        input:focus, textarea:focus {
            border-color: var(--verde);
            box-shadow: 0 0 0 2px rgba(58, 195, 125, 0.2);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            width: 100%;
            margin-top: 8px;
        }

        .checkbox-item {
            position: relative;
        }

        .checkbox-item input[type="checkbox"] {
            display: none;
        }

        .checkbox-item label {
            background: #f8f8f8;
            border-radius: 5px;
            padding: 14px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            text-align: center;
            font-weight: 500;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-wrap: break-word;
            width: 100%;
        }

        .checkbox-item label:hover {
            background: #e9fff0;
            transform: scale(1.03);
        }

        .checkbox-item input[type="checkbox"]:checked + label {
            background: var(--verde);
            color: #fff;
            border: 2px solid var(--verde-hover);
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(58, 195, 125, 0.3);
        }

        .btn-principal {
            background-color: var(--verde);
            color: #fff;
            border: none;
            border-radius: 5px;
            padding: 14px 40px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.25s ease, background-color 0.25s ease;
            width: 100%;
            max-width: 400px;
            margin: 1rem auto 0;
            font-weight: 600;
        }

        .btn-principal:hover {
            background-color: var(--verde-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(58, 195, 125, 0.3);
        }

        .error {
            color: #d32f2f;
            font-weight: 600;
            padding: 12px 16px;
            background-color: #ffebee;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .success {
            color: #155724;
            font-weight: 600;
            padding: 12px 16px;
            background-color: #d4edda;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        @@media (max-width: 768px) {
            .contenedor {
                padding: 2rem 1.5rem;
            }

            .checkbox-group {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @@media (max-width: 480px) {
            .contenedor {
                padding: 1.5rem 1.2rem;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        #map {
            z-index: 1;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <header>
        <div class="header-content">
            <h1>‚öôÔ∏è Configuraci√≥n</h1>
            @{
                var tipoPrincipal = ViewBag.TipoPrincipal?.ToString() ?? "";
                var urlVolver = tipoPrincipal == "Paseador" ? "/Proveedor/DashboardPaseador" : 
                               tipoPrincipal == "Cuidador" ? "/Proveedor/DashboardCuidador" : 
                               "/Proveedor/Dashboard";
            }
            <a href="@urlVolver" class="btn-volver">‚Üê Volver</a>
        </div>
    </header>

    <div class="container">
        <div class="contenedor">
            @if (TempData["Error"] != null)
            {
                <div class="error">@TempData["Error"]</div>
            }

            @if (TempData["Exito"] != null)
            {
                <div class="success">@TempData["Exito"]</div>
            }

            <div class="titulo-principal">
                <h2>Editar Perfil</h2>
            </div>

            <form method="post" asp-action="Configuracion" asp-controller="Proveedor" class="formulario" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="campo-grupo" style="text-align: center; margin-bottom: 30px;">
                    <label class="label-text" style="margin-bottom: 15px;">Foto de Perfil</label>
                    <div style="position: relative; display: inline-block;">
                        @if (ViewBag.Proveedor?["FotoPerfil"] != null && ViewBag.Proveedor["FotoPerfil"] != DBNull.Value && !string.IsNullOrEmpty(ViewBag.Proveedor["FotoPerfil"].ToString()))
                        {
                            <img id="fotoPreview" src="@ViewBag.Proveedor["FotoPerfil"]" alt="Foto de perfil" style="width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--verde); cursor: pointer; box-shadow: var(--sombra-media);" onclick="document.getElementById('fotoPerfilInput').click();" />
                        }
                        else
                        {
                            <div id="fotoPreview" style="width: 150px; height: 150px; border-radius: 50%; background: var(--gris-claro); display: flex; align-items: center; justify-content: center; font-size: 48px; cursor: pointer; border: 4px solid var(--verde); box-shadow: var(--sombra-media);" onclick="document.getElementById('fotoPerfilInput').click();">üì∑</div>
                        }
                        <input type="file" id="fotoPerfilInput" name="fotoPerfil" accept="image/*" style="display: none;" />
                    </div>
                    <p style="margin-top: 10px; font-size: 12px; color: var(--gris);">Hac√© clic en la imagen para cambiar tu foto</p>
                </div>

                <div class="campo-grupo">
                    <label class="label-text">DNI <span class="required">*</span></label>
                    <input type="text" name="dni" value="@(ViewBag.Proveedor?["DNI"])" required maxlength="20" />
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Nombre Completo Legal <span class="required">*</span></label>
                    <input type="text" name="nombreCompleto" value="@(ViewBag.Proveedor?["NombreCompleto"])" required maxlength="200" />
                </div>

                <div class="campo-grupo">
                    <label class="label-text">A√±os de Experiencia <span class="required">*</span></label>
                    <input type="number" name="experiencia" value="@(ViewBag.Proveedor?["Experiencia_Anios"])" required min="0" max="100" />
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Descripci√≥n</label>
                    <textarea name="descripcion" placeholder="Contanos sobre tu experiencia y servicios..." maxlength="1000">@(ViewBag.Proveedor?["Descripcion"])</textarea>
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Tel√©fono</label>
                    <input type="text" name="telefono" value="@(ViewBag.Proveedor?["Telefono"])" maxlength="30" />
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Direcci√≥n</label>
                    <input type="text" name="direccion" value="@(ViewBag.Proveedor?["Direccion"])" maxlength="200" />
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Pa√≠s</label>
                    <select id="Pais" name="pais" style="width: 100%; padding: 13px 16px; border-radius: 5px; border: 1.8px solid var(--gris-claro); outline: none; font-size: 15px; font-family: 'Poppins', sans-serif;">
                        <option value="">Seleccionar pa√≠s</option>
                    </select>
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Provincia</label>
                    <select id="Provincia" name="provincia" disabled style="width: 100%; padding: 13px 16px; border-radius: 5px; border: 1.8px solid var(--gris-claro); outline: none; font-size: 15px; font-family: 'Poppins', sans-serif;">
                        <option value="">Seleccionar provincia</option>
                    </select>
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Ciudad</label>
                    <select id="Ciudad" name="ciudad" disabled style="width: 100%; padding: 13px 16px; border-radius: 5px; border: 1.8px solid var(--gris-claro); outline: none; font-size: 15px; font-family: 'Poppins', sans-serif;">
                        <option value="">Seleccionar ciudad</option>
                    </select>
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Precio por Hora</label>
                    <input type="number" name="precioHora" value="@(ViewBag.Proveedor?["Precio_Hora"])" step="0.01" min="0" />
                </div>

                <div class="campo-grupo">
                    <label class="label-text">üìç Zona de Atenci√≥n</label>
                    <p style="font-size: 13px; color: #666; margin-bottom: 10px;">
                        @{
                            var tipoPrincipal = ViewBag.TipoPrincipal?.ToString() ?? "";
                            if (tipoPrincipal == "Paseador")
                            {
                                <text>Marc√° tu ubicaci√≥n y ajust√° el radio de cobertura (c√≠rculo azul)</text>
                            }
                            else if (tipoPrincipal == "Cuidador")
                            {
                                <text>Marc√° tu ubicaci√≥n precisa donde brind√°s el servicio</text>
                            }
                            else
                            {
                                <text>Marc√° tu ubicaci√≥n en el mapa</text>
                            }
                        }
                    </p>
                    <div id="map" style="width: 100%; height: 400px; border-radius: 12px; border: 2px solid var(--gris-claro); margin-bottom: 15px;"></div>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-size: 13px; color: var(--gris); margin-bottom: 5px; display: block;">Latitud</label>
                            <input type="number" id="latitud" name="latitud" step="0.00000001" value="@(ViewBag.Proveedor?["Latitud"])" style="width: 100%; padding: 10px; border-radius: 8px; border: 1.8px solid var(--gris-claro);" readonly />
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <label style="font-size: 13px; color: var(--gris); margin-bottom: 5px; display: block;">Longitud</label>
                            <input type="number" id="longitud" name="longitud" step="0.00000001" value="@(ViewBag.Proveedor?["Longitud"])" style="width: 100%; padding: 10px; border-radius: 8px; border: 1.8px solid var(--gris-claro);" readonly />
                        </div>
                        @if (tipoPrincipal == "Paseador")
                        {
                            <div style="flex: 1; min-width: 200px;">
                                <label style="font-size: 13px; color: var(--gris); margin-bottom: 5px; display: block;">Radio de Atenci√≥n (km)</label>
                                <input type="number" id="radioAtencion" name="radioAtencion" step="0.5" min="1" max="50" value="@(ViewBag.Proveedor?["Radio_Atencion_Km"] ?? 5)" style="width: 100%; padding: 10px; border-radius: 8px; border: 1.8px solid var(--gris-claro);" />
                            </div>
                        }
                    </div>
                    <button type="button" id="btnObtenerUbicacion" style="margin-top: 10px; padding: 10px 20px; background-color: var(--verde); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        üìç Usar Mi Ubicaci√≥n Actual
                    </button>
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Tipos de Servicio que Ofreces <span class="required">*</span></label>
                    <div class="checkbox-group">
                        @if (ViewBag.TodosTiposServicio != null && ViewBag.TodosTiposServicio.Rows.Count > 0)
                        {
                            var tiposSeleccionados = new HashSet<int>();
                            if (ViewBag.TiposServicio != null)
                            {
                                foreach (System.Data.DataRow tipo in ViewBag.TiposServicio.Rows)
                                {
                                    tiposSeleccionados.Add(Convert.ToInt32(tipo["Id_TipoServicio"]));
                                }
                            }

                            foreach (System.Data.DataRow tipo in ViewBag.TodosTiposServicio.Rows)
                            {
                                int tipoId = Convert.ToInt32(tipo["Id_TipoServicio"]);
                                bool estaSeleccionado = tiposSeleccionados.Contains(tipoId);
                                <div class="checkbox-item">
                                    <input type="checkbox" name="tiposServicio" value="@tipoId" id="tipo_@tipoId" @(estaSeleccionado ? "checked" : "") />
                                    <label for="tipo_@tipoId">@tipo["Descripcion"]</label>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="campo-grupo">
                    <label class="label-text">Especies que Atiendes <span class="required">*</span></label>
                    <div class="checkbox-group">
                        @{
                            var especiesSeleccionadas = new HashSet<string>();
                            if (ViewBag.Especies != null)
                            {
                                foreach (System.Data.DataRow especie in ViewBag.Especies.Rows)
                                {
                                    especiesSeleccionadas.Add(especie["Especie"].ToString());
                                }
                            }

                            var todasEspecies = new[] { "Perro", "Gato", "Conejo", "Ave", "Pez", "Reptil" };
                            var emojis = new Dictionary<string, string>
                            {
                                { "Perro", "üêï" },
                                { "Gato", "üêà" },
                                { "Conejo", "üê∞" },
                                { "Ave", "ü¶ú" },
                                { "Pez", "üê†" },
                                { "Reptil", "ü¶é" }
                            };
                        }

                        @foreach (var especie in todasEspecies)
                        {
                            bool estaSeleccionada = especiesSeleccionadas.Contains(especie);
                            <div class="checkbox-item">
                                <input type="checkbox" name="especies" value="@especie" id="especie_@especie.ToLower()" @(estaSeleccionada ? "checked" : "") />
                                <label for="especie_@especie.ToLower()">@(emojis.ContainsKey(especie) ? emojis[especie] : "") @especie</label>
                            </div>
                        }
                    </div>
                </div>

                <button type="submit" class="btn-principal">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script>
        let map;
        let marker;
        let circle;
        let tipoPrincipal = '@(ViewBag.TipoPrincipal?.ToString() ?? "")';
        let latitudActual = @(ViewBag.Proveedor?["Latitud"] != null && ViewBag.Proveedor["Latitud"] != DBNull.Value ? ViewBag.Proveedor["Latitud"].ToString().Replace(",", ".") : "-34.6037");
        let longitudActual = @(ViewBag.Proveedor?["Longitud"] != null && ViewBag.Proveedor["Longitud"] != DBNull.Value ? ViewBag.Proveedor["Longitud"].ToString().Replace(",", ".") : "-58.3816");
        let radioActual = @(ViewBag.Proveedor?["Radio_Atencion_Km"] != null && ViewBag.Proveedor["Radio_Atencion_Km"] != DBNull.Value ? ViewBag.Proveedor["Radio_Atencion_Km"].ToString().Replace(",", ".") : "5");

        function initMap() {
            // Inicializar mapa centrado en ubicaci√≥n actual o Buenos Aires por defecto
            map = L.map('map').setView([latitudActual, longitudActual], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Si hay ubicaci√≥n guardada, mostrar marcador
            if (latitudActual && longitudActual && latitudActual != -34.6037) {
                actualizarMarcador(latitudActual, longitudActual);
            }

            // Evento click en el mapa
            map.on('click', function(e) {
                actualizarMarcador(e.latlng.lat, e.latlng.lng);
            });

            // Evento cambio de radio (solo para paseadores)
            if (tipoPrincipal === 'Paseador') {
                document.getElementById('radioAtencion').addEventListener('input', function() {
                    if (marker) {
                        actualizarCirculo();
                    }
                });
            }
        }

        function actualizarMarcador(lat, lng) {
            // Actualizar inputs
            document.getElementById('latitud').value = lat.toFixed(8);
            document.getElementById('longitud').value = lng.toFixed(8);

            // Eliminar marcador y c√≠rculo anteriores
            if (marker) {
                map.removeLayer(marker);
            }
            if (circle) {
                map.removeLayer(circle);
            }

            // Crear nuevo marcador
            marker = L.marker([lat, lng], {
                draggable: true
            }).addTo(map);

            // Evento drag del marcador
            marker.on('dragend', function(e) {
                const pos = marker.getLatLng();
                actualizarMarcador(pos.lat, pos.lng);
            });

            // Actualizar c√≠rculo si es paseador
            if (tipoPrincipal === 'Paseador') {
                actualizarCirculo();
            }

            // Centrar mapa en el marcador
            map.setView([lat, lng], map.getZoom());
        }

        function actualizarCirculo() {
            if (!marker) return;

            const radio = parseFloat(document.getElementById('radioAtencion').value) || 5;
            const pos = marker.getLatLng();

            // Eliminar c√≠rculo anterior
            if (circle) {
                map.removeLayer(circle);
            }

            // Crear nuevo c√≠rculo (radio en metros)
            circle = L.circle([pos.lat, pos.lng], {
                radius: radio * 1000, // Convertir km a metros
                color: '#4A90E2',
                fillColor: '#4A90E2',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(map);
        }

        // Bot√≥n obtener ubicaci√≥n actual
        document.getElementById('btnObtenerUbicacion').addEventListener('click', function() {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta geolocalizaci√≥n');
                return;
            }

            this.textContent = 'üìç Obteniendo ubicaci√≥n...';
            this.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    actualizarMarcador(lat, lng);
                    map.setView([lat, lng], 15);
                    document.getElementById('btnObtenerUbicacion').textContent = 'üìç Usar Mi Ubicaci√≥n Actual';
                    document.getElementById('btnObtenerUbicacion').disabled = false;
                },
                function(error) {
                    alert('No se pudo obtener tu ubicaci√≥n. Por favor, marc√° tu ubicaci√≥n en el mapa.');
                    document.getElementById('btnObtenerUbicacion').textContent = 'üìç Usar Mi Ubicaci√≥n Actual';
                    document.getElementById('btnObtenerUbicacion').disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        });

        // Preview de foto de perfil
        const fotoPerfilInput = document.getElementById('fotoPerfilInput');
        if (fotoPerfilInput) {
            fotoPerfilInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validar tama√±o (m√°ximo 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('La imagen es demasiado grande. Por favor selecciona una imagen menor a 5MB.');
                        this.value = '';
                        return;
                    }
                    
                    // Validar tipo
                    if (!file.type.startsWith('image/')) {
                        alert('Por favor selecciona un archivo de imagen v√°lido.');
                        this.value = '';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('fotoPreview');
                        if (preview) {
                            if (preview.tagName === 'IMG') {
                                preview.src = e.target.result;
                            } else {
                                // Reemplazar el div con una imagen
                                const img = document.createElement('img');
                                img.id = 'fotoPreview';
                                img.src = e.target.result;
                                img.alt = 'Foto de perfil';
                                img.style.cssText = 'width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 4px solid var(--verde); cursor: pointer; box-shadow: var(--sombra-media);';
                                img.onclick = () => document.getElementById('fotoPerfilInput').click();
                                preview.parentNode.replaceChild(img, preview);
                            }
                        }
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        // Inicializar mapa cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            initCountryStateCity();
        });

        // Inicializar country-state-city
        function initCountryStateCity() {
            if (typeof window.csc === 'undefined') {
                setTimeout(initCountryStateCity, 100);
                return;
            }

            const { Country, State, City } = window.csc;
            const pais = document.getElementById("Pais");
            const prov = document.getElementById("Provincia");
            const ciudad = document.getElementById("Ciudad");

            if (!pais || !prov || !ciudad) return;

            const flag = a2 => String.fromCodePoint(...[...a2.toUpperCase()].map(c => 127397 + c.charCodeAt(0)));
            const countries = Country.getAllCountries();
            
            // Cargar pa√≠ses
            const paisGuardado = '@(ViewBag.Proveedor?["Pais"])';
            pais.innerHTML = '<option value="">Seleccionar pa√≠s</option>' + 
                countries.map(c => {
                    const selected = c.name === paisGuardado ? 'selected' : '';
                    return `<option value="${c.name}" ${selected}>${flag(c.isoCode)} ${c.name}</option>`;
                }).join("");

            // Si hay pa√≠s guardado, cargar provincias
            if (paisGuardado) {
                const isoPais = countries.find(c => c.name === paisGuardado)?.isoCode;
                if (isoPais) {
                    const provincias = State.getStatesOfCountry(isoPais);
                    const provGuardada = '@(ViewBag.Proveedor?["Provincia"])';
                    prov.innerHTML = '<option value="">Seleccionar provincia</option>' + 
                        provincias.map(s => {
                            const selected = s.name === provGuardada ? 'selected' : '';
                            return `<option value="${s.name}" ${selected}>${s.name}</option>`;
                        }).join("");
                    prov.disabled = provincias.length === 0;

                    // Si hay provincia guardada, cargar ciudades
                    if (provGuardada) {
                        const estado = State.getStatesOfCountry(isoPais).find(s => s.name === provGuardada);
                        if (estado) {
                            const ciudades = City.getCitiesOfState(isoPais, estado.isoCode);
                            const ciudadGuardada = '@(ViewBag.Proveedor?["Ciudad"])';
                            ciudad.innerHTML = '<option value="">Seleccionar ciudad</option>' + 
                                ciudades.map(c => {
                                    const selected = c.name === ciudadGuardada ? 'selected' : '';
                                    return `<option value="${c.name}" ${selected}>${c.name}</option>`;
                                }).join("");
                            ciudad.disabled = ciudades.length === 0;
                        }
                    }
                }
            }

            pais.addEventListener("change", function() {
                const iso = countries.find(c => c.name === this.value)?.isoCode;
                if (iso) {
                    const provincias = State.getStatesOfCountry(iso);
                    prov.innerHTML = '<option value="">Seleccionar provincia</option>' + 
                        provincias.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
                    prov.disabled = provincias.length === 0;
                    ciudad.innerHTML = '<option value="">Seleccionar ciudad</option>';
                    ciudad.disabled = true;
                } else {
                    prov.innerHTML = '<option value="">Seleccionar provincia</option>';
                    prov.disabled = true;
                    ciudad.innerHTML = '<option value="">Seleccionar ciudad</option>';
                    ciudad.disabled = true;
                }
            });

            prov.addEventListener("change", function() {
                const isoPais = countries.find(c => c.name === pais.value)?.isoCode;
                if (isoPais && this.value) {
                    const estado = State.getStatesOfCountry(isoPais).find(s => s.name === this.value);
                    if (estado) {
                        const ciudades = City.getCitiesOfState(isoPais, estado.isoCode);
                        ciudad.innerHTML = '<option value="">Seleccionar ciudad</option>' + 
                            ciudades.map(c => `<option value="${c.name}">${c.name}</option>`).join("");
                        ciudad.disabled = ciudades.length === 0;
                    }
                } else {
                    ciudad.innerHTML = '<option value="">Seleccionar ciudad</option>';
                    ciudad.disabled = true;
                }
            });
        }
    </script>
    <script src="~/lib/country-state-city/country-state-city.umd.min.js"></script>
</body>
</html>

