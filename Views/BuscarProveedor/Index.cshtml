@{
    ViewData["Title"] = "Buscar Proveedores - Zooni";
}

<h2>Buscar Proveedores de Servicios</h2>

<div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 12px; border-left: 4px solid #2196F3;">
    <p style="margin: 0; color: #1976D2; font-weight: 600;">
        üìç <button type="button" id="btnUsarMiUbicacion" style="background: none; border: none; color: #1976D2; text-decoration: underline; cursor: pointer; font-weight: 600; font-size: inherit;">Usar mi ubicaci√≥n</button> para encontrar proveedores cercanos
    </p>
    <p id="mensajeUbicacion" style="margin: 5px 0 0 0; color: #666; font-size: 13px; display: none;"></p>
</div>

<form method="get" asp-action="Index" asp-controller="BuscarProveedor" id="formBusqueda" style="margin-bottom: 30px; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <input type="hidden" id="latitud" name="latitud" value="@ViewBag.Latitud" />
    <input type="hidden" id="longitud" name="longitud" value="@ViewBag.Longitud" />
    <input type="hidden" id="radioKm" name="radioKm" value="@(ViewBag.RadioKm ?? 10)" />
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Pa√≠s</label>
            <select id="Pais" name="pais" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="">Todos los pa√≠ses</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Provincia</label>
            <select id="Provincia" name="provincia" disabled style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="">Todas las provincias</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Ciudad</label>
            <select id="Ciudad" name="ciudad" disabled style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="">Todas las ciudades</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo de Servicio</label>
            <select name="tipoServicio" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="">Todos</option>
                @if (ViewBag.TiposServicio != null)
                {
                    foreach (System.Data.DataRow tipo in ViewBag.TiposServicio.Rows)
                    {
                        <option value="@tipo["Descripcion"]" selected="@(ViewBag.TipoServicio == tipo["Descripcion"].ToString())">@tipo["Descripcion"]</option>
                    }
                }
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Especie</label>
            <select name="especie" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;">
                <option value="">Todas</option>
                <option value="Perro" selected="@(ViewBag.Especie == "Perro")">Perro</option>
                <option value="Gato" selected="@(ViewBag.Especie == "Gato")">Gato</option>
                <option value="Conejo" selected="@(ViewBag.Especie == "Conejo")">Conejo</option>
                <option value="Ave" selected="@(ViewBag.Especie == "Ave")">Ave</option>
                <option value="Pez" selected="@(ViewBag.Especie == "Pez")">Pez</option>
                <option value="Reptil" selected="@(ViewBag.Especie == "Reptil")">Reptil</option>
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Radio de B√∫squeda (km)</label>
            <input type="number" id="radioKmInput" name="radioKm" value="@(ViewBag.RadioKm ?? 10)" min="1" max="50" step="1" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc;" />
        </div>
    </div>
    <button type="submit" style="margin-top: 15px; padding: 12px 24px; background-color: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">Buscar</button>
</form>

@if (ViewBag.Proveedores != null && ViewBag.Proveedores.Rows.Count > 0)
{
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
        @foreach (System.Data.DataRow proveedor in ViewBag.Proveedores.Rows)
        {
            <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                @if (!string.IsNullOrEmpty(proveedor["FotoPerfil"]?.ToString()))
                {
                    <img src="@proveedor["FotoPerfil"]" alt="Foto" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 15px;" />
                }
                else
                {
                    <div style="width: 100%; height: 200px; background: #f0f0f0; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; color: #999;">
                        Sin foto
                    </div>
                }
                
                <h3 style="margin: 0 0 10px 0; color: #8B5E3C;">@proveedor["NombreCompleto"]</h3>
                
                @if (!string.IsNullOrEmpty(proveedor["Descripcion"]?.ToString()))
                {
                    <p style="color: #666; font-size: 14px; margin: 0 0 10px 0;">@(proveedor["Descripcion"].ToString().Length > 100 ? proveedor["Descripcion"].ToString().Substring(0, 100) + "..." : proveedor["Descripcion"].ToString())</p>
                }
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 10px 0;">
                    <div>
                        <span style="color: #FFD700; font-size: 18px;">‚≠ê</span>
                        <span style="font-weight: 600;">@proveedor["Calificacion_Promedio"]</span>
                        <span style="color: #999; font-size: 12px;">(@proveedor["Cantidad_Resenas"] rese√±as)</span>
                    </div>
                    @if (proveedor["Precio_Hora"] != DBNull.Value)
                    {
                        <span style="font-weight: 600; color: #6c757d;">$@proveedor["Precio_Hora"]/hora</span>
                    }
                </div>
                
                <div style="margin: 10px 0; color: #666; font-size: 14px;">
                    <p style="margin: 5px 0;">üìç @proveedor["Ciudad"], @proveedor["Provincia"]</p>
                    <p style="margin: 5px 0;">üìÖ @proveedor["Experiencia_Anios"] a√±os de experiencia</p>
                    @if (proveedor.Table.Columns.Contains("Distancia_Km") && proveedor["Distancia_Km"] != DBNull.Value)
                    {
                        decimal distancia = Convert.ToDecimal(proveedor["Distancia_Km"]);
                        string distanciaTexto = distancia < 1 ? $"{(distancia * 1000):F0} m" : $"{distancia:F1} km";
                        <p style="margin: 5px 0; color: #2196F3; font-weight: 600;">üìè A @distanciaTexto de distancia</p>
                    }
                </div>
                
                <a href="/BuscarProveedor/Perfil/@proveedor["Id_Proveedor"]" style="display: block; text-align: center; padding: 10px; background-color: #6c757d; color: white; border-radius: 8px; text-decoration: none; margin-top: 15px; font-weight: 600;">
                    Ver Perfil
                </a>
            </div>
        }
    </div>
}
else
{
    <div style="text-align: center; padding: 40px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <p style="color: #999; font-size: 18px;">No se encontraron proveedores con los criterios de b√∫squeda.</p>
    </div>
}

<script>
    // Sincronizar input de radio con hidden
    document.getElementById('radioKmInput').addEventListener('input', function() {
        document.getElementById('radioKm').value = this.value;
    });

    // Bot√≥n usar mi ubicaci√≥n
    document.getElementById('btnUsarMiUbicacion').addEventListener('click', function() {
        if (!navigator.geolocation) {
            alert('Tu navegador no soporta geolocalizaci√≥n');
            return;
        }

        const btn = this;
        const mensaje = document.getElementById('mensajeUbicacion');
        btn.textContent = 'üìç Obteniendo ubicaci√≥n...';
        btn.disabled = true;
        mensaje.style.display = 'block';
        mensaje.textContent = 'Obteniendo tu ubicaci√≥n...';
        mensaje.style.color = '#666';

        navigator.geolocation.getCurrentPosition(
            function(position) {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                
                document.getElementById('latitud').value = lat;
                document.getElementById('longitud').value = lng;
                
                mensaje.textContent = `‚úÖ Ubicaci√≥n obtenida. Busc√° proveedores cercanos.`;
                mensaje.style.color = '#4CAF50';
                btn.textContent = 'üìç Ubicaci√≥n obtenida';
                btn.disabled = false;
                
                // Auto-buscar si hay otros filtros
                setTimeout(() => {
                    document.getElementById('formBusqueda').submit();
                }, 500);
            },
            function(error) {
                mensaje.textContent = '‚ùå No se pudo obtener tu ubicaci√≥n. Pod√©s buscar por ciudad y provincia.';
                mensaje.style.color = '#f44336';
                btn.textContent = 'üìç Usar mi ubicaci√≥n';
                btn.disabled = false;
            },
            { enableHighAccuracy: true, timeout: 10000 }
        );
    });

    // Si ya hay coordenadas, mostrar mensaje
    @if (ViewBag.Latitud != null && ViewBag.Longitud != null)
    {
        <text>
        document.getElementById('mensajeUbicacion').style.display = 'block';
        document.getElementById('mensajeUbicacion').textContent = '‚úÖ Buscando proveedores cercanos a tu ubicaci√≥n';
        document.getElementById('mensajeUbicacion').style.color = '#4CAF50';
        </text>
    }

    // Inicializar country-state-city
    function initCountryStateCity() {
        if (typeof window.csc === 'undefined') {
            setTimeout(initCountryStateCity, 100);
            return;
        }

        const { Country, State, City } = window.csc;
        const pais = document.getElementById("Pais");
        const prov = document.getElementById("Provincia");
        const ciudad = document.getElementById("Ciudad");

        if (!pais || !prov || !ciudad) return;

        const flag = a2 => String.fromCodePoint(...[...a2.toUpperCase()].map(c => 127397 + c.charCodeAt(0)));
        const countries = Country.getAllCountries();
        
        // Cargar pa√≠ses
        const paisGuardado = '@ViewBag.Pais';
        pais.innerHTML = '<option value="">Todos los pa√≠ses</option>' + 
            countries.map(c => {
                const selected = c.name === paisGuardado ? 'selected' : '';
                return `<option value="${c.name}" ${selected}>${flag(c.isoCode)} ${c.name}</option>`;
            }).join("");

        // Si hay pa√≠s guardado, cargar provincias
        if (paisGuardado) {
            const isoPais = countries.find(c => c.name === paisGuardado)?.isoCode;
            if (isoPais) {
                const provincias = State.getStatesOfCountry(isoPais);
                const provGuardada = '@ViewBag.Provincia';
                prov.innerHTML = '<option value="">Todas las provincias</option>' + 
                    provincias.map(s => {
                        const selected = s.name === provGuardada ? 'selected' : '';
                        return `<option value="${s.name}" ${selected}>${s.name}</option>`;
                    }).join("");
                prov.disabled = provincias.length === 0;

                // Si hay provincia guardada, cargar ciudades
                if (provGuardada) {
                    const estado = State.getStatesOfCountry(isoPais).find(s => s.name === provGuardada);
                    if (estado) {
                        const ciudades = City.getCitiesOfState(isoPais, estado.isoCode);
                        const ciudadGuardada = '@ViewBag.Ciudad';
                        ciudad.innerHTML = '<option value="">Todas las ciudades</option>' + 
                            ciudades.map(c => {
                                const selected = c.name === ciudadGuardada ? 'selected' : '';
                                return `<option value="${c.name}" ${selected}>${c.name}</option>`;
                            }).join("");
                        ciudad.disabled = ciudades.length === 0;
                    }
                }
            }
        }

        pais.addEventListener("change", function() {
            const iso = countries.find(c => c.name === this.value)?.isoCode;
            if (iso) {
                const provincias = State.getStatesOfCountry(iso);
                prov.innerHTML = '<option value="">Todas las provincias</option>' + 
                    provincias.map(s => `<option value="${s.name}">${s.name}</option>`).join("");
                prov.disabled = provincias.length === 0;
                ciudad.innerHTML = '<option value="">Todas las ciudades</option>';
                ciudad.disabled = true;
            } else {
                prov.innerHTML = '<option value="">Todas las provincias</option>';
                prov.disabled = true;
                ciudad.innerHTML = '<option value="">Todas las ciudades</option>';
                ciudad.disabled = true;
            }
        });

        prov.addEventListener("change", function() {
            const isoPais = countries.find(c => c.name === pais.value)?.isoCode;
            if (isoPais && this.value) {
                const estado = State.getStatesOfCountry(isoPais).find(s => s.name === this.value);
                if (estado) {
                    const ciudades = City.getCitiesOfState(isoPais, estado.isoCode);
                    ciudad.innerHTML = '<option value="">Todas las ciudades</option>' + 
                        ciudades.map(c => `<option value="${c.name}">${c.name}</option>`).join("");
                    ciudad.disabled = ciudades.length === 0;
                }
            } else {
                ciudad.innerHTML = '<option value="">Todas las ciudades</option>';
                ciudad.disabled = true;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        initCountryStateCity();
    });
</script>
<script src="~/lib/country-state-city/country-state-city.umd.min.js"></script>

