@{
    ViewData["Title"] = "Planificador de Servicios - Zooni";
    Layout = null;
    var tema = ViewBag.Tema ?? "claro";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="~/css/zooni-design-system.css" />
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--fondo-claro);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        h1 {
            color: var(--marron);
            margin: 0;
        }
        .btn-volver {
            background: var(--gris-claro);
            color: var(--gris);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .card h2 {
            color: var(--marron);
            margin-top: 0;
            font-size: 1.3rem;
        }
        .reserva-item {
            padding: 15px;
            border-left: 4px solid var(--verde);
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .reserva-item.pendiente { border-left-color: #ffc107; }
        .reserva-item.confirmada { border-left-color: #17a2b8; }
        .reserva-item.en-curso { border-left-color: var(--verde); }
        .reserva-item.completada { border-left-color: #6c757d; }
        .btn-nueva-reserva {
            background: var(--verde);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
        }
        .btn-nueva-reserva:hover {
            background: var(--verde-hover);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal.activo {
            display: flex;
        }
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .campo {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--gris);
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1.8px solid var(--gris-claro);
            font-family: 'Poppins', sans-serif;
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }
        .btn-accion {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
        }
        .btn-cancelar {
            background: #dc3545;
            color: white;
        }
        .btn-ver {
            background: var(--verde);
            color: white;
        }
    </style>
</head>
<body class="tema-@tema">
    <div class="container">
        <div class="header">
            <h1>üìÖ Planificador de Servicios</h1>
            <a href="/Home/Index" class="btn-volver">‚Üê Volver</a>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìã Pr√≥ximas Reservas</h2>
                <div id="listaReservas">
                    @if (ViewBag.Reservas != null && ViewBag.Reservas.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow reserva in ViewBag.Reservas.Rows)
                        {
                            string estado = reserva["Estado"]?.ToString() ?? "Pendiente";
                            string estadoClass = estado.ToLower().Replace(" ", "-");
                            <div class="reserva-item @estadoClass">
                                <strong>@reserva["MascotaNombre"] (@reserva["MascotaEspecie"])</strong><br>
                                <span>@reserva["TipoServicio"]</span><br>
                                <span>üìÖ @Convert.ToDateTime(reserva["Fecha_Inicio"]).ToString("dd/MM/yyyy")</span><br>
                                <span>üïê @TimeSpan.Parse(reserva["Hora_Inicio"].ToString()).ToString(@"hh\:mm")</span><br>
                                <span>‚è±Ô∏è @reserva["Duracion_Horas"] horas</span><br>
                                <span>üí∞ $@reserva["Precio_Total"]</span><br>
                                <span>üë§ @reserva["ProveedorNombre"]</span><br>
                                <span>Estado: <strong>@estado</strong></span><br>
                                @if (estado == "Pendiente" || estado == "Confirmada")
                                {
                                    <button class="btn-accion btn-cancelar" onclick="cancelarReserva(@reserva["Id_Reserva"])">Cancelar</button>
                                }
                                @if (estado == "EnCurso")
                                {
                                    <a href="/Paseo/Tracking?idReserva=@reserva["Id_Reserva"]" class="btn-accion btn-ver">Ver Tracking</a>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <p>No ten√©s reservas programadas</p>
                    }
                </div>
                <button class="btn-nueva-reserva" onclick="mostrarModalNuevaReserva()">‚ûï Nueva Reserva</button>
            </div>

            <div class="card">
                <h2>‚≠ê Proveedores Favoritos</h2>
                <div id="listaFavoritos">
                    @if (ViewBag.Favoritos != null && ViewBag.Favoritos.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow favorito in ViewBag.Favoritos.Rows)
                        {
                            <div class="reserva-item">
                                <strong>@favorito["NombreCompleto"]</strong><br>
                                <span>üí∞ $@favorito["Precio_Hora"]/hora</span><br>
                                <span>üìä @favorito["CantidadReservas"] reservas</span><br>
                                @if (favorito["CalificacionPromedio"] != DBNull.Value)
                                {
                                    <span>‚≠ê @Math.Round(Convert.ToDouble(favorito["CalificacionPromedio"]), 1)</span>
                                }
                                <br>
                                <a href="/Home/ContratarProveedor/@favorito["Id_Proveedor"]" class="btn-accion btn-ver">Contratar</a>
                            </div>
                        }
                    }
                    else
                    {
                        <p>No ten√©s proveedores favoritos a√∫n</p>
                        <a href="/Home/BuscarProveedores" class="btn-accion btn-ver">Buscar Proveedores</a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Reserva -->
    <div id="modalNuevaReserva" class="modal">
        <div class="modal-content">
            <h2>Nueva Reserva</h2>
            <form id="formNuevaReserva">
                <div class="campo">
                    <label>Proveedor *</label>
                    <select id="idProveedor" required>
                        <option value="">Seleccionar proveedor</option>
                    </select>
                </div>
                <div class="campo">
                    <label>Mascota *</label>
                    <select id="idMascota" required>
                        <option value="">Seleccionar mascota</option>
                        @if (ViewBag.Mascotas != null)
                        {
                            foreach (System.Data.DataRow mascota in ViewBag.Mascotas.Rows)
                            {
                                <option value="@mascota["Id_Mascota"]">@mascota["Nombre"] (@mascota["Especie"])</option>
                            }
                        }
                    </select>
                </div>
                <div class="campo">
                    <label>Tipo de Servicio *</label>
                    <select id="idTipoServicio" required>
                        <option value="">Seleccionar servicio</option>
                    </select>
                </div>
                <div class="campo">
                    <label>Fecha *</label>
                    <input type="date" id="fechaInicio" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <div class="campo">
                    <label>Hora *</label>
                    <input type="time" id="horaInicio" required />
                </div>
                <div class="campo">
                    <label>Duraci√≥n (horas) *</label>
                    <input type="number" id="duracionHoras" min="0.5" max="24" step="0.5" value="1" required />
                </div>
                <div class="campo">
                    <label>Direcci√≥n del Servicio (opcional)</label>
                    <input type="text" id="direccionServicio" placeholder="Direcci√≥n donde se realizar√° el servicio" />
                </div>
                <div class="campo">
                    <label>Notas (opcional)</label>
                    <textarea id="notas" placeholder="Instrucciones especiales, preferencias, etc."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-nueva-reserva" style="flex: 1;">Crear Reserva</button>
                    <button type="button" class="btn-accion btn-cancelar" onclick="cerrarModal()" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Cargar proveedores y tipos de servicio
        async function cargarProveedores() {
            try {
                const response = await fetch('/Home/ObtenerProveedores');
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('idProveedor');
                    select.innerHTML = '<option value="">Seleccionar proveedor</option>';
                    data.proveedores.forEach(prov => {
                        const option = document.createElement('option');
                        option.value = prov.id;
                        option.textContent = `${prov.nombre} - $${prov.precioHora}/hora`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar proveedores:', error);
            }
        }

        document.getElementById('idProveedor')?.addEventListener('change', async function() {
            const idProveedor = this.value;
            if (!idProveedor) return;

            try {
                const response = await fetch(`/Home/ObtenerTiposServicio/${idProveedor}`);
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('idTipoServicio');
                    select.innerHTML = '<option value="">Seleccionar servicio</option>';
                    data.tipos.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.descripcion;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar tipos de servicio:', error);
            }
        });

        function mostrarModalNuevaReserva() {
            document.getElementById('modalNuevaReserva').classList.add('activo');
            cargarProveedores();
        }

        function cerrarModal() {
            document.getElementById('modalNuevaReserva').classList.remove('activo');
            document.getElementById('formNuevaReserva').reset();
        }

        document.getElementById('formNuevaReserva')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                idProveedor: parseInt(document.getElementById('idProveedor').value),
                idMascota: parseInt(document.getElementById('idMascota').value),
                idTipoServicio: parseInt(document.getElementById('idTipoServicio').value),
                fechaInicio: document.getElementById('fechaInicio').value,
                horaInicio: document.getElementById('horaInicio').value,
                duracionHoras: parseFloat(document.getElementById('duracionHoras').value),
                direccionServicio: document.getElementById('direccionServicio').value,
                notas: document.getElementById('notas').value
            };

            try {
                const response = await fetch('/Planificador/CrearReserva', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('¬°Reserva creada exitosamente!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'No se pudo crear la reserva'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear la reserva');
            }
        });

        async function cancelarReserva(idReserva) {
            if (!confirm('¬øEst√°s seguro de que quer√©s cancelar esta reserva?')) return;

            try {
                const response = await fetch('/Planificador/CancelarReserva', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idReserva: idReserva })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Reserva cancelada exitosamente');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'No se pudo cancelar la reserva'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cancelar la reserva');
            }
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalNuevaReserva')?.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });
    </script>
</body>
</html>

