@{
    ViewData["Title"] = "Comunidad - Zooni";
    Layout = null;
    var tema = ViewBag.Tema ?? Context.Session.GetString("Tema") ?? "claro";
}

<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>@ViewData["Title"]</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
<!-- Leaflet (OpenStreetMap) - Gratis y sin API Key -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root {
    --verde: #39b77c;
    --amarillo: #FFD85A;
    --marron: #3c2a1b;
    --fondo-claro: #f9f9f8;
    --fondo-oscuro: #121212;
    --texto-claro: #3c2a1b;
    --texto-oscuro: #ffffff;
    --card-claro: rgba(255,255,255,0.95);
    --card-oscuro: rgba(30,30,30,0.95);
}

* {
    box-sizing: border-box;
}

html, body {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: 'Poppins', sans-serif;
    overflow: hidden;
}

body.tema-claro {
    background: var(--fondo-claro);
    color: var(--texto-claro);
}

body.tema-oscuro {
    background: var(--fondo-oscuro);
    color: var(--texto-oscuro);
}

header {
    position: fixed;
    top: 15px;
    left: 20px;
    z-index: 1000;
}

.menu-icon {
    width: 38px;
    height: 38px;
    cursor: pointer;
    transition: transform .25s ease, filter .3s ease;
    filter: brightness(0);
}
body.tema-oscuro .menu-icon {
    filter: brightness(0) invert(1);
}
.menu-icon:hover { transform: scale(1.1); }

.menu-lateral {
    position: fixed;
    top: 0;
    left: 0;
    transform: translateX(-100%);
    width: 240px;
    height: 100%;
    box-shadow: 4px 0 18px rgba(0,0,0,0.15);
    display: flex;
    flex-direction: column;
    padding: 2.5rem 1.2rem;
    gap: 1rem;
    transition: transform 0.35s ease, background .4s ease, color .4s ease;
    border-top-right-radius: 18px;
    border-bottom-right-radius: 18px;
    z-index: 9999;
}
body.tema-claro .menu-lateral {
    background: #ffffff;
}
body.tema-oscuro .menu-lateral {
    background: rgba(30,30,30,0.98);
    box-shadow: 4px 0 18px rgba(0,0,0,0.5);
}
.menu-lateral.abierto { transform: translateX(0); }
.menu-lateral a {
    text-decoration: none;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 0.6rem 0.8rem;
    border-radius: 12px;
    transition: all .25s ease;
    color: inherit;
}
body.tema-claro .menu-lateral a {
    color: var(--marron);
}
body.tema-oscuro .menu-lateral a {
    color: #ffffff;
}
body.tema-claro .menu-lateral a:hover {
    background: var(--amarillo);
    color: #3c2a00;
}
body.tema-oscuro .menu-lateral a:hover {
    background: var(--verde);
    color: #ffffff;
}
.cerrar-menu {
    align-self: flex-end;
    font-size: 1.6rem;
    cursor: pointer;
    margin-bottom: 1.2rem;
    transition: transform 0.2s ease, color .3s ease;
    color: inherit;
}
body.tema-claro .cerrar-menu {
    color: var(--marron);
}
body.tema-oscuro .cerrar-menu {
    color: #ffffff;
}
.cerrar-menu:hover {
    transform: scale(1.2);
}
.overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.25);
    opacity: 0;
    pointer-events: none;
    transition: opacity .3s ease;
    z-index: 8;
}
.overlay.activo { opacity: 1; pointer-events: auto; }

#map {
    width: 100%;
    height: 100vh;
    position: relative;
    z-index: 1;
}

/* Estilos para marcadores personalizados */
.mi-ubicacion-marker,
.amigo-marker {
    background: transparent !important;
    border: none !important;
}

/* Estilos para controles de zoom de Leaflet */
.leaflet-control-zoom {
    border: none !important;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3) !important;
    border-radius: 12px !important;
    overflow: hidden !important;
    margin-top: 180px !important; /* Mover debajo de los botones de control */
    margin-right: 20px !important;
}

.leaflet-control-zoom a {
    width: 40px !important;
    height: 40px !important;
    line-height: 40px !important;
    font-size: 22px !important;
    font-weight: bold !important;
    background: var(--card-claro) !important;
    color: var(--texto-claro) !important;
    border: 2px solid rgba(0,0,0,0.1) !important;
    transition: all 0.3s ease !important;
}

body.tema-oscuro .leaflet-control-zoom a {
    background: var(--card-oscuro) !important;
    color: var(--texto-oscuro) !important;
    border-color: rgba(255,255,255,0.1) !important;
}

.leaflet-control-zoom a:hover {
    background: var(--verde) !important;
    color: white !important;
    transform: scale(1.05) !important;
}

.leaflet-control-zoom-in {
    border-top-left-radius: 12px !important;
    border-top-right-radius: 12px !important;
    border-bottom: 1px solid rgba(0,0,0,0.1) !important;
}

body.tema-oscuro .leaflet-control-zoom-in {
    border-bottom-color: rgba(255,255,255,0.1) !important;
}

.leaflet-control-zoom-out {
    border-bottom-left-radius: 12px !important;
    border-bottom-right-radius: 12px !important;
}

.leaflet-control-zoom a.leaflet-disabled {
    opacity: 0.5 !important;
    cursor: not-allowed !important;
    background: rgba(0,0,0,0.1) !important;
}

.controles-mapa {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.btn-servicios-flotante {
    position: fixed;
    bottom: 340px;
    right: 20px;
    z-index: 1001;
    background: linear-gradient(135deg, var(--verde) 0%, #2ea968 100%);
    color: white;
    border: none;
    padding: 14px 20px;
    border-radius: 50px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    box-shadow: 0 4px 16px rgba(58, 195, 125, 0.4);
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}
.btn-servicios-flotante:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(58, 195, 125, 0.5);
}
.btn-servicios-flotante:active {
    transform: translateY(-1px);
}

.btn-control {
    background: var(--card-claro);
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: 12px;
    padding: 12px 16px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all .3s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    color: inherit;
}
body.tema-oscuro .btn-control {
    background: var(--card-oscuro);
    border-color: rgba(255,255,255,0.1);
}
.btn-control:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}
.btn-control.activo {
    background: var(--verde);
    color: white;
    border-color: var(--verde);
}

.panel-amigos {
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    max-width: 400px;
    background: var(--card-claro);
    border-radius: 20px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    z-index: 1000;
    max-height: 400px;
    overflow-y: auto;
    transition: max-height 0.3s ease;
}
.panel-amigos.tab-servicios-activo {
    max-height: 60vh;
}
body.tema-oscuro .panel-amigos {
    background: var(--card-oscuro);
}
.panel-amigos h3 {
    margin: 0 0 15px 0;
    font-size: 1.2rem;
    color: inherit;
}

.tabs {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    border-bottom: 2px solid rgba(0,0,0,0.1);
    padding-bottom: 10px;
}
body.tema-oscuro .tabs {
    border-bottom-color: rgba(255,255,255,0.1);
}
.tab-btn {
    flex: 1;
    padding: 8px 12px;
    border: none;
    background: transparent;
    color: inherit;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    border-radius: 8px;
    transition: all .2s ease;
    opacity: 0.6;
}
.tab-btn.tab-servicios {
    background: linear-gradient(135deg, var(--verde) 0%, #2ea968 100%);
    color: white !important;
    opacity: 1;
    font-weight: 700;
    box-shadow: 0 2px 8px rgba(58, 195, 125, 0.3);
    transform: scale(1.05);
}
.tab-btn.tab-servicios:hover {
    transform: scale(1.08);
    box-shadow: 0 4px 12px rgba(58, 195, 125, 0.4);
}
.tab-btn.tab-servicios.activo {
    background: linear-gradient(135deg, var(--verde) 0%, #2ea968 100%);
    opacity: 1;
    box-shadow: 0 4px 12px rgba(58, 195, 125, 0.5);
}
.tab-btn.activo {
    opacity: 1;
    background: var(--verde);
    color: white;
}
.tab-content {
    display: block;
}
.tab-content.oculto {
    display: none;
}

.input-buscar {
    width: 100%;
    padding: 12px;
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: 10px;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    margin-bottom: 15px;
    box-sizing: border-box;
}
body.tema-claro .input-buscar {
    background: white;
    color: var(--texto-claro);
}
body.tema-oscuro .input-buscar {
    background: rgba(40,40,40,0.8);
    color: var(--texto-oscuro);
    border-color: rgba(255,255,255,0.1);
}
.input-buscar:focus {
    outline: none;
    border-color: var(--verde);
    box-shadow: 0 0 0 3px rgba(57, 195, 125, 0.1);
}

.usuario-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    border-radius: 10px;
    background: rgba(0,0,0,0.05);
    margin-bottom: 10px;
    transition: all .2s ease;
}
body.tema-oscuro .usuario-item {
    background: rgba(255,255,255,0.05);
}
.usuario-item:hover {
    background: var(--amarillo);
    transform: translateX(5px);
}
.usuario-info {
    flex: 1;
}
.usuario-nombre {
    font-weight: 600;
    font-size: 0.95rem;
    color: inherit;
    margin: 0 0 3px 0;
}
.usuario-email {
    font-size: 0.85rem;
    opacity: 0.7;
    color: inherit;
    margin: 0;
}
.usuario-mascota {
    font-size: 0.85rem;
    opacity: 0.7;
    color: inherit;
    margin: 3px 0 0 0;
}
.btn-agregar-usuario {
    padding: 8px 16px;
    background: var(--verde);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all .2s ease;
}
.btn-agregar-usuario:hover {
    background: #2fa76b;
    transform: scale(1.05);
}
.btn-eliminar-amigo {
    padding: 8px 16px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all .2s ease;
}
.btn-eliminar-amigo:hover {
    background: #cc0000;
    transform: scale(1.05);
}
.lista-amigos {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.amigo-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px;
    border-radius: 10px;
    background: rgba(0,0,0,0.05);
    cursor: pointer;
    transition: all .2s ease;
}
body.tema-oscuro .amigo-item {
    background: rgba(255,255,255,0.05);
}
.amigo-item:hover {
    background: var(--amarillo);
    transform: translateX(5px);
}
.amigo-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    border: 2px solid var(--verde);
}
.amigo-info {
    flex: 1;
}
.amigo-nombre {
    font-weight: 600;
    font-size: 0.95rem;
    color: inherit;
    margin: 0;
}
.amigo-mascota {
    font-size: 0.85rem;
    opacity: 0.7;
    color: inherit;
    margin: 0;
}

.modal-agregar-amigo {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}
.modal-agregar-amigo.activo {
    display: flex;
}
.modal-content {
    background: var(--card-claro);
    border-radius: 20px;
    padding: 30px;
    max-width: 400px;
    width: 90%;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
}
body.tema-oscuro .modal-content {
    background: var(--card-oscuro);
}
.modal-content h3 {
    margin: 0 0 20px 0;
    color: inherit;
}
.modal-content input {
    width: 100%;
    padding: 12px;
    border: 2px solid rgba(0,0,0,0.1);
    border-radius: 10px;
    font-family: 'Poppins', sans-serif;
    font-size: 1rem;
    margin-bottom: 15px;
    box-sizing: border-box;
}
body.tema-claro .modal-content input {
    background: white;
    color: var(--texto-claro);
}
body.tema-oscuro .modal-content input {
    background: rgba(40,40,40,0.8);
    color: var(--texto-oscuro);
    border-color: rgba(255,255,255,0.1);
}
.modal-buttons {
    display: flex;
    gap: 10px;
}
.btn-modal {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all .3s ease;
}
.btn-primary {
    background: var(--verde);
    color: white;
}
.btn-primary:hover {
    background: #2fa76b;
}
.btn-secondary {
    background: #888;
    color: white;
}
.btn-secondary:hover {
    background: #666;
}

.mensaje {
    position: fixed;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 600;
    z-index: 10001;
    animation: slideDown 0.3s ease;
}
.mensaje-exito {
    background: var(--verde);
    color: white;
}
.mensaje-error {
    background: #ff4444;
    color: white;
}
@@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@@media (max-width: 768px) {
    .panel-amigos {
        max-width: 100%;
        left: 10px;
        right: 10px;
        bottom: 10px;
    }
    .panel-amigos.tab-servicios-activo {
        max-height: 70vh;
    }
    .controles-mapa {
        top: 70px;
        right: 10px;
    }
    .btn-control {
        padding: 10px 12px;
        font-size: 0.85rem;
    }
    .btn-servicios-flotante {
        bottom: 320px;
        right: 15px;
        padding: 12px 18px;
        font-size: 0.9rem;
    }
    .tab-btn.tab-servicios {
        font-size: 0.85rem;
        padding: 6px 10px;
    }
    .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }
    .tabs::-webkit-scrollbar {
        display: none;
    }
}
</style>
</head>

<body class="tema-@tema">
<header>
    <img src="/img/icons/hamburger.png" alt="Men√∫" class="menu-icon" id="abrirMenu" />
</header>

<div class="menu-lateral" id="menuLateral">
    <div class="cerrar-menu" id="cerrarMenu">‚úñ</div>
    <a href="/Home/Index">üè† Inicio</a>
    <a href="/Home/Comunidad">üë• Comunidad</a>
    <a href="/Home/Planificador">üìÖ Planificador de Servicios</a>
    <a href="/Marketplace">üõí Marketplace</a>
    <a href="/Home/FichaMedica">üíâ Ficha m√©dica</a>
    <a href="/Home/Calendario">üìÖ Calendario</a>
    <a href="/Chat/ChatZooni">üí¨ ChatBot</a>
    <a href="/Home/Closet">üëï Closet</a>
    <a href="/Home/Perfil">üë§ Perfil</a>
    <a href="/Home/Configuracion">‚öôÔ∏è Configuraci√≥n</a>
    <a href="/Auth/Logout" style="color:red;">üö™ Cerrar sesi√≥n</a>
</div>
<div class="overlay" id="overlay"></div>

<div id="map"></div>

<div class="controles-mapa">
    <button class="btn-control" id="btnMiUbicacion" onclick="centrarEnMiUbicacion()">üìç Mi Ubicaci√≥n</button>
    <button class="btn-control" id="btnAgregarAmigo" onclick="mostrarModalAmigo()">‚ûï Agregar Amigo</button>
    <button class="btn-control" id="btnCrearCartel" onclick="activarModoCrearCartel()" style="background: #e74c3c;">üö® Crear Cartel</button>
</div>

<button class="btn-servicios-flotante" onclick="cambiarTab('proveedores'); setTimeout(() => { document.getElementById('panelAmigos').scrollIntoView({ behavior: 'smooth', block: 'end' }); }, 100);">
    üîß Ver Servicios
</button>

<div class="panel-amigos" id="panelAmigos">
    <div class="tabs">
        <button class="tab-btn activo" onclick="cambiarTab('amigos')">üë• Amigos</button>
        <button class="tab-btn tab-servicios" onclick="cambiarTab('proveedores')">üîß Servicios</button>
        <button class="tab-btn" onclick="cambiarTab('solicitudes')">üì© Solicitudes</button>
        <button class="tab-btn" onclick="cambiarTab('buscar')">üîç Buscar</button>
        <button class="tab-btn" onclick="cambiarTab('sugeridos')">‚≠ê Sugeridos</button>
    </div>
    
    <div class="tab-content" id="tabAmigos">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
            <h3 style="margin: 0;">üë• Mis Amigos</h3>
            <select id="selectUbicacion" onchange="cambiarEstadoUbicacion()" style="padding: 6px 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 0.85rem; cursor: pointer; background: white;">
                <option value="nadie">üîí Para nadie</option>
                <option value="amigos" selected>Solo para amigos</option>
                <option value="todos">üåç Para todos</option>
            </select>
        </div>
        <div class="lista-amigos" id="listaAmigos">
            <p style="text-align: center; opacity: 0.7; color: inherit;">Cargando amigos...</p>
        </div>
    </div>
    
    <div class="tab-content oculto" id="tabSolicitudes">
        <h3>üì© Solicitudes de Amistad</h3>
        <div class="lista-amigos" id="listaSolicitudes">
            <p style="text-align: center; opacity: 0.7; color: inherit;">Cargando solicitudes...</p>
        </div>
    </div>
    
    <div class="tab-content oculto" id="tabBuscar">
        <h3>üîç Buscar Usuarios</h3>
        <input type="text" id="inputBuscar" placeholder="Buscar por nombre o email..." class="input-buscar" onkeyup="buscarUsuarios()" />
        <div class="lista-amigos" id="listaBusqueda">
            <p style="text-align: center; opacity: 0.7; color: inherit;">Escrib√≠ para buscar usuarios...</p>
        </div>
    </div>
    
    <div class="tab-content oculto" id="tabSugeridos">
        <h3>‚≠ê Usuarios Sugeridos</h3>
        <div class="lista-amigos" id="listaSugeridos">
            <p style="text-align: center; opacity: 0.7; color: inherit;">Cargando sugeridos...</p>
        </div>
    </div>
    
    <div class="tab-content oculto" id="tabProveedores">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0;">üîß Servicios Disponibles</h3>
            <input type="text" id="buscarServicios" placeholder="üîç Buscar servicios..." 
                   style="padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.1); width: 200px; font-size: 0.9rem;"
                   onkeyup="filtrarServicios(this.value)" />
        </div>
        <div class="lista-amigos" id="listaProveedores">
            <p style="text-align: center; opacity: 0.7; color: inherit;">Cargando servicios...</p>
        </div>
    </div>
</div>

<div class="modal-agregar-amigo" id="modalAmigo">
    <div class="modal-content">
        <h3>‚ûï Agregar Nuevo Amigo</h3>
        <input type="text" id="inputEmailAmigo" placeholder="Email del amigo" />
        <div class="modal-buttons">
            <button class="btn-modal btn-primary" onclick="agregarAmigo()">Agregar</button>
            <button class="btn-modal btn-secondary" onclick="cerrarModalAmigo()">Cancelar</button>
        </div>
    </div>
</div>

<div class="modal-agregar-amigo" id="modalContratar">
    <div class="modal-content" style="max-width: 500px;">
        <h3>üìÖ Contratar Servicio</h3>
        <div id="modalContratarContent">
            <p>Cargando...</p>
        </div>
    </div>
</div>

<div class="modal-agregar-amigo" id="modalCartel">
    <div class="modal-content" style="max-width: 500px;">
        <h3>üö® Crear Cartel de Mascota</h3>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tipo:</label>
            <select id="selectTipoCartel" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="Perdida">üî¥ Mascota Perdida</option>
                <option value="Encontrada">üü¢ Mascota Encontrada</option>
            </select>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Mascota (opcional):</label>
            <select id="selectMascotaCartel" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="">Ninguna (mascota gen√©rica)</option>
            </select>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Descripci√≥n:</label>
            <textarea id="textareaDescripcionCartel" placeholder="Descripci√≥n de la mascota, caracter√≠sticas, √∫ltima vez vista..." style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd; min-height: 80px; resize: vertical;"></textarea>
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tel√©fono de Contacto: *</label>
            <input type="text" id="inputTelefonoCartel" placeholder="Ej: +54 11 1234-5678" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;" required />
        </div>
        <div style="margin-bottom: 15px;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Foto de la Mascota (opcional):</label>
            <input type="file" id="inputFotoCartel" accept="image/*" style="width: 100%; padding: 8px; border-radius: 8px; border: 1px solid #ddd;" />
            <small style="color: #666; font-size: 0.85rem;">Formatos aceptados: JPG, PNG, GIF</small>
        </div>
        <div class="modal-buttons">
            <button class="btn-modal btn-primary" onclick="crearCartel()">Crear Cartel</button>
            <button class="btn-modal btn-secondary" onclick="cerrarModalCartel()">Cancelar</button>
        </div>
    </div>
</div>

<script>
let map;
let miMarcador;
let marcadoresAmigos = {};
let marcadoresCarteles = {};
let marcadoresProveedores = {};
let circuloProveedor = null;
let proveedorSeleccionado = null;
let miUbicacion = null;
let watchId = null;
let modalCartelLat = null;
let modalCartelLng = null;

const menu = document.getElementById("menuLateral");
const overlay = document.getElementById("overlay");
document.getElementById("abrirMenu").onclick = () => {
    menu.classList.add("abierto");
    overlay.classList.add("activo");
};
document.getElementById("cerrarMenu").onclick = cerrarMenu;
overlay.onclick = cerrarMenu;

function cerrarMenu() {
    menu.classList.remove("abierto");
    overlay.classList.remove("activo");
}

// Inicializar mapa cuando la p√°gina carga
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});

function initMap() {
    // Inicializar mapa con Leaflet (OpenStreetMap) centrado en Buenos Aires con zoom m√°s cercano
    map = L.map('map', {
        zoomControl: false  // Desactivar zoom control por defecto
    }).setView([-34.6037, -58.3816], 17);
    
    // Agregar capa de OpenStreetMap
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Agregar controles de zoom en posici√≥n personalizada (esquina superior derecha, debajo de los botones)
    L.control.zoom({
        position: 'topright'
    }).addTo(map);

    // Obtener ubicaci√≥n del usuario
    obtenerMiUbicacion();
    
    // Cargar amigos
    cargarAmigos();
    
    // Cargar sugeridos
    cargarSugeridos();
    
    // Cargar solicitudes
    cargarSolicitudes();
    
    // Cargar estado de ubicaci√≥n mostrable
    cargarEstadoUbicacionMostrable();
    
    // Cargar puntos de inter√©s
    cargarPuntosInteres();
    
    // Cargar carteles de mascotas
    cargarCarteles();
    
    // Cargar proveedores
    cargarProveedores();
    
    // Agregar listener para doble clic en el mapa (crear cartel)
    map.on('dblclick', function(e) {
        mostrarModalCrearCartel(e.latlng.lat, e.latlng.lng);
    });
    
    // Actualizar lista de amigos cada 30 segundos (sin mostrar mensajes)
    setInterval(function() {
        cargarAmigos();
    }, 30000);
    
    // Actualizar carteles cada 60 segundos
    setInterval(function() {
        cargarCarteles();
    }, 60000);
}

function obtenerMiUbicacion() {
    if (!navigator.geolocation) {
        mostrarMensaje("Tu navegador no soporta geolocalizaci√≥n", "error");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        function(position) {
            miUbicacion = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            // Centrar mapa en mi ubicaci√≥n con zoom m√°s cercano
            map.setView([miUbicacion.lat, miUbicacion.lng], 17);
            
            // Crear o actualizar mi marcador
            if (miMarcador) {
                miMarcador.setLatLng([miUbicacion.lat, miUbicacion.lng]);
            } else {
                // Icono personalizado para mi ubicaci√≥n (m√°s grande)
                const miIcono = L.divIcon({
                    className: 'mi-ubicacion-marker',
                    html: '<div style="background: #39b77c; width: 35px; height: 35px; border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4);"></div>',
                    iconSize: [35, 35],
                    iconAnchor: [17.5, 17.5]
                });
                
                miMarcador = L.marker([miUbicacion.lat, miUbicacion.lng], {
                    icon: miIcono,
                    title: "Tu ubicaci√≥n"
                }).addTo(map);
            }
            
            // Guardar ubicaci√≥n en el servidor
            guardarUbicacion(miUbicacion.lat, miUbicacion.lng);
            
            // Iniciar seguimiento continuo autom√°tico
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }
            watchId = navigator.geolocation.watchPosition(
                function(pos) {
                    const nuevaLat = pos.coords.latitude;
                    const nuevaLng = pos.coords.longitude;
                    
                    // Calcular distancia desde la √∫ltima ubicaci√≥n guardada
                    const distancia = calcularDistanciaMetros(
                        miUbicacion.lat, 
                        miUbicacion.lng, 
                        nuevaLat, 
                        nuevaLng
                    );
                    
                    // Solo actualizar si se movi√≥ m√°s de 10 metros (para evitar demasiadas peticiones)
                    if (distancia > 10) {
                        miUbicacion = {
                            lat: nuevaLat,
                            lng: nuevaLng
                        };
                        
                        // Actualizar marcador en el mapa
                        if (miMarcador) {
                            miMarcador.setLatLng([miUbicacion.lat, miUbicacion.lng]);
                        }
                        
                        // Guardar ubicaci√≥n en el servidor
                        guardarUbicacion(miUbicacion.lat, miUbicacion.lng);
                    }
                },
                function(error) {
                    console.error("Error en seguimiento:", error);
                },
                { 
                    enableHighAccuracy: true, 
                    maximumAge: 5000,
                    timeout: 10000
                }
            );
        },
        function(error) {
            mostrarMensaje("No se pudo obtener tu ubicaci√≥n", "error");
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// Funci√≥n auxiliar para calcular distancia en metros
function calcularDistanciaMetros(lat1, lng1, lat2, lng2) {
    const R = 6371000; // Radio de la Tierra en metros
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = 
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function centrarEnMiUbicacion() {
    if (miUbicacion) {
        map.setView([miUbicacion.lat, miUbicacion.lng], 17);
    } else {
        obtenerMiUbicacion();
    }
}

function guardarUbicacion(lat, lng) {
    fetch('/Home/GuardarUbicacion', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ lat: lat, lng: lng })
    })
    .catch(err => console.error('Error al guardar ubicaci√≥n:', err));
}

// Funci√≥n eliminada - la ubicaci√≥n se actualiza autom√°ticamente con watchPosition

function cargarAmigos() {
    fetch('/Home/ObtenerAmigos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarAmigos(data.amigos);
                actualizarMarcadoresAmigos(data.amigos);
            } else {
                document.getElementById('listaAmigos').innerHTML = 
                    '<p style="text-align: center; opacity: 0.7; color: inherit;">No ten√©s amigos agregados a√∫n</p>';
            }
        })
        .catch(err => {
            console.error('Error al cargar amigos:', err);
            document.getElementById('listaAmigos').innerHTML = 
                '<p style="text-align: center; opacity: 0.7; color: inherit;">Error al cargar amigos</p>';
        });
}

function mostrarAmigos(amigos) {
    const lista = document.getElementById('listaAmigos');
    if (!amigos || amigos.length === 0) {
        lista.innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">No ten√©s amigos agregados a√∫n</p>';
        return;
    }
    
    lista.innerHTML = amigos.map(amigo => {
        const nombreMostrar = amigo.nombreMostrar || amigo.nombre || 'Usuario';
        const nombreEscapado = (amigo.nombre || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const tieneUbicacion = amigo.lat != null && amigo.lng != null;
        const onclickUbicacion = tieneUbicacion ? `onclick="centrarEnAmigo(${amigo.lat}, ${amigo.lng})"` : '';
        const estiloClick = tieneUbicacion ? 'cursor: pointer;' : 'cursor: default;';
        return `
        <div class="amigo-item">
            <div style="position: relative; display: inline-block;">
                <img src="${amigo.fotoPerfil || '/img/perfil/default.png'}" alt="${nombreMostrar}" class="amigo-avatar" ${onclickUbicacion} onerror="this.src='/img/perfil/default.png'" />
                ${amigo.estaOnline ? '<span class="estado-online" style="position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #2ecc71; border: 2px solid white; border-radius: 50%;"></span>' : '<span class="estado-offline" style="position: absolute; bottom: 2px; right: 2px; width: 12px; height: 12px; background: #95a5a6; border: 2px solid white; border-radius: 50%;"></span>'}
            </div>
            <div class="amigo-info" ${onclickUbicacion} style="flex: 1; ${estiloClick}">
                <p class="amigo-nombre">${nombreMostrar} ${amigo.estaOnline ? '<span style="color: #2ecc71; font-size: 0.7rem;">üü¢</span>' : '<span style="color: #95a5a6; font-size: 0.7rem;">‚ö´</span>'}</p>
                ${amigo.apodo ? `<p style="font-size: 0.75rem; opacity: 0.7; font-style: italic; margin: 0;">(${amigo.nombre})</p>` : ''}
                <p class="amigo-mascota">üêæ ${amigo.mascotaNombre || 'Sin mascota'}</p>
                ${!tieneUbicacion ? '<p style="font-size: 0.7rem; opacity: 0.6; margin: 2px 0 0 0; color: #e74c3c;">üìç Sin ubicaci√≥n</p>' : ''}
            </div>
           <div style="display: flex; gap: 5px;">
               <button class="btn-eliminar-amigo" onclick="abrirChat(${amigo.id})" style="background: #39b77c; font-size: 0.7rem; padding: 4px 6px;" title="Enviar mensaje">üí¨</button>
               <button class="btn-eliminar-amigo" onclick="editarApodo(${amigo.id}, '${nombreEscapado}')" style="background: #3498db; font-size: 0.7rem; padding: 4px 6px;" title="Editar apodo">‚úèÔ∏è</button>
               <button class="btn-eliminar-amigo" onclick="eliminarAmigo(${amigo.id}, '${nombreEscapado}')" title="Eliminar amigo">üóëÔ∏è</button>
           </div>
        </div>
    `}).join('');
}

function cambiarTab(tab) {
    // Ocultar todos los tabs
    document.querySelectorAll('.tab-content').forEach(t => t.classList.add('oculto'));
    document.querySelectorAll('.tab-btn').forEach(b => {
        b.classList.remove('activo');
        // Mantener el estilo destacado del tab de servicios
        if (b.classList.contains('tab-servicios')) {
            b.classList.add('tab-servicios');
        }
    });
    
    // Mapear nombres de tabs a IDs
    const tabMap = {
        'amigos': 'tabAmigos',
        'solicitudes': 'tabSolicitudes',
        'buscar': 'tabBuscar',
        'sugeridos': 'tabSugeridos',
        'proveedores': 'tabProveedores'
    };
    
    // Mostrar el tab seleccionado
    const tabId = tabMap[tab] || `tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`;
    const tabActivo = document.getElementById(tabId);
    if (tabActivo) {
        tabActivo.classList.remove('oculto');
    } else {
        console.error('Tab no encontrado:', tabId);
    }
    
    // Activar el bot√≥n correspondiente
    const btnActivo = document.querySelector(`.tab-btn[onclick*="'${tab}'"]`);
    if (btnActivo) {
        btnActivo.classList.add('activo');
        // Si es el tab de servicios, expandir el panel
        if (btnActivo.classList.contains('tab-servicios')) {
            document.getElementById('panelAmigos').classList.add('tab-servicios-activo');
        } else {
            document.getElementById('panelAmigos').classList.remove('tab-servicios-activo');
        }
    }
    
    // Cargar datos seg√∫n el tab
    if (tab === 'sugeridos') {
        cargarSugeridos();
    } else if (tab === 'amigos') {
        cargarAmigos();
    } else if (tab === 'solicitudes') {
        cargarSolicitudes();
    } else if (tab === 'proveedores') {
        cargarProveedores();
    }
}

let timeoutBusqueda;
function buscarUsuarios() {
    clearTimeout(timeoutBusqueda);
    const query = document.getElementById('inputBuscar').value.trim();
    
    if (query.length < 2) {
        document.getElementById('listaBusqueda').innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">Escrib√≠ al menos 2 caracteres para buscar...</p>';
        return;
    }
    
    timeoutBusqueda = setTimeout(() => {
        fetch(`/Home/BuscarUsuarios?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    mostrarResultadosBusqueda(data.usuarios);
                } else {
                    document.getElementById('listaBusqueda').innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">Error al buscar usuarios</p>';
                }
            })
            .catch(err => {
                console.error('Error:', err);
                document.getElementById('listaBusqueda').innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">Error al buscar usuarios</p>';
            });
    }, 300);
}

function mostrarResultadosBusqueda(usuarios) {
    const lista = document.getElementById('listaBusqueda');
    if (!usuarios || usuarios.length === 0) {
        lista.innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">No se encontraron usuarios</p>';
        return;
    }
    
    lista.innerHTML = usuarios.map(usuario => `
        <div class="usuario-item">
            <img src="${usuario.fotoPerfil || '/img/perfil/default.png'}" alt="${usuario.nombre}" class="amigo-avatar" />
            <div class="usuario-info">
                <p class="usuario-nombre">${usuario.nombre}</p>
                <p class="usuario-email">${usuario.email}</p>
                <p class="usuario-mascota">üêæ ${usuario.mascotaNombre || 'Sin mascota'}</p>
            </div>
            <button class="btn-agregar-usuario" onclick="agregarAmigoPorId(${usuario.id}, '${usuario.email}')">‚ûï</button>
        </div>
    `).join('');
}

function cargarSugeridos() {
    fetch('/Home/ObtenerUsuariosSugeridos')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarSugeridos(data.sugeridos);
            } else {
                document.getElementById('listaSugeridos').innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">Error al cargar sugeridos</p>';
            }
        })
        .catch(err => {
            console.error('Error:', err);
            document.getElementById('listaSugeridos').innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">Error al cargar sugeridos</p>';
        });
}

function mostrarSugeridos(sugeridos) {
    const lista = document.getElementById('listaSugeridos');
    if (!sugeridos || sugeridos.length === 0) {
        lista.innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">No hay usuarios sugeridos</p>';
        return;
    }
    
    lista.innerHTML = sugeridos.map(usuario => `
        <div class="usuario-item">
            <img src="${usuario.fotoPerfil || '/img/perfil/default.png'}" alt="${usuario.nombre}" class="amigo-avatar" />
            <div class="usuario-info">
                <p class="usuario-nombre">${usuario.nombre}</p>
                <p class="usuario-email">${usuario.email}</p>
                <p class="usuario-mascota">üêæ ${usuario.mascotaNombre || 'Sin mascota'}</p>
            </div>
            <button class="btn-agregar-usuario" onclick="agregarAmigoPorId(${usuario.id}, '${usuario.email}')">‚ûï</button>
        </div>
    `).join('');
}

function agregarAmigoPorId(usuarioId, email) {
    fetch('/Home/AgregarAmigo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Amigo agregado correctamente", "exito");
            cargarAmigos();
            cargarSugeridos();
            if (document.getElementById('tabBuscar').classList.contains('oculto') === false) {
                buscarUsuarios();
            }
        } else {
            mostrarMensaje(data.message || "Error al agregar amigo", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al agregar amigo", "error");
    });
}

function eliminarAmigo(amigoId, nombre) {
    if (!confirm(`¬øEst√°s seguro de que quer√©s eliminar a ${nombre} de tus amigos?`)) {
        return;
    }
    
    fetch('/Home/EliminarAmigo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ amigoId: amigoId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Amigo eliminado correctamente", "exito");
            cargarAmigos();
        } else {
            mostrarMensaje(data.message || "Error al eliminar amigo", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al eliminar amigo", "error");
    });
}

function actualizarMarcadoresAmigos(amigos) {
    // Remover marcadores antiguos
    Object.values(marcadoresAmigos).forEach(marker => map.removeLayer(marker));
    marcadoresAmigos = {};
    
    if (!amigos || amigos.length === 0) return;
    
    // Agrupar amigos por ubicaci√≥n (misma lat/lng)
    const gruposUbicacion = {};
    amigos.forEach(amigo => {
        if (amigo.lat && amigo.lng) {
            const key = `${amigo.lat.toFixed(6)}_${amigo.lng.toFixed(6)}`;
            if (!gruposUbicacion[key]) {
                gruposUbicacion[key] = [];
            }
            gruposUbicacion[key].push(amigo);
        }
    });
    
    // Crear marcadores, separando los que est√°n en la misma ubicaci√≥n
    Object.keys(gruposUbicacion).forEach(key => {
        const grupo = gruposUbicacion[key];
        const latBase = parseFloat(grupo[0].lat);
        const lngBase = parseFloat(grupo[0].lng);
        
        // Verificar si est√°n cerca de la ubicaci√≥n del usuario
        let separarDeUsuario = false;
        if (miUbicacion) {
            const distanciaUsuario = Math.sqrt(
                Math.pow(latBase - miUbicacion.lat, 2) + 
                Math.pow(lngBase - miUbicacion.lng, 2)
            );
            // Si est√°n a menos de ~25 metros del usuario, separarlos
            if (distanciaUsuario < 0.00025) {
                separarDeUsuario = true;
            }
        }
        
        grupo.forEach((amigo, index) => {
            // Separar marcadores en patr√≥n circular para que se vean bien
            let lat, lng;
            // Si hay m√°s de 1 amigo en la misma ubicaci√≥n o est√°n cerca del usuario, usar patr√≥n circular
            if (grupo.length > 1 || separarDeUsuario) {
                // Radio de separaci√≥n m√°s grande para que se vean bien separados
                // ~25-30 metros si est√° cerca del usuario (para separarlo del c√≠rculo verde)
                // ~20 metros entre amigos en la misma ubicaci√≥n
                const radio = separarDeUsuario ? 0.00025 : 0.0002; // ~25 metros del usuario, ~20 metros entre amigos
                // √Ångulo en radianes para distribuir en c√≠rculo
                // Si est√° cerca del usuario, usar 4 posiciones fijas (norte, sur, este, oeste)
                // Si hay m√∫ltiples amigos, distribuir en c√≠rculo
                let angulo;
                if (separarDeUsuario && grupo.length === 1) {
                    // Separar del usuario en una de las 4 direcciones cardinales
                    angulo = (index % 4) * (Math.PI / 2); // 0, 90, 180, 270 grados
                } else {
                    // Distribuir en c√≠rculo
                    angulo = (index * 2 * Math.PI) / (grupo.length > 1 ? grupo.length : 4);
                }
                // Offset circular
                lat = latBase + (radio * Math.cos(angulo));
                lng = lngBase + (radio * Math.sin(angulo));
            } else {
                // Si solo hay uno y no est√° cerca del usuario, usar la ubicaci√≥n original
                lat = latBase;
                lng = lngBase;
            }
            
            const nombreMostrar = amigo.nombreMostrar || amigo.nombre || 'Usuario';
            const avatarUrl = amigo.mascotaAvatar || '/img/mascotas/default.png';
            
            const iconoAmigo = L.divIcon({
                className: 'amigo-marker',
                html: `
                    <div style="position: relative; text-align: center;">
                        <img src="${avatarUrl}" 
                             alt="${amigo.mascotaNombre || 'Mascota'}" 
                             style="width: 60px; height: 60px; border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); object-fit: cover; background: #fff;"
                             onerror="this.onerror=null; this.src='/img/mascotas/default.png';" />
                        <div style="position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); white-space: nowrap; background: rgba(0,0,0,0.8); color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; max-width: 100px; overflow: hidden; text-overflow: ellipsis;">
                            ${nombreMostrar}
                        </div>
                    </div>
                `,
                iconSize: [80, 80],
                iconAnchor: [40, 40],
                popupAnchor: [0, -40]
            });
            
            const marker = L.marker([lat, lng], {
                icon: iconoAmigo,
                title: `${nombreMostrar} - ${amigo.mascotaNombre || 'Sin mascota'}`
            }).addTo(map);
            
            const popup = L.popup({
                maxWidth: 200
            }).setContent(`
                <div style="padding: 8px; text-align: center;">
                    <img src="${avatarUrl}" 
                         alt="${amigo.mascotaNombre || 'Mascota'}" 
                         style="width: 70px; height: 70px; border-radius: 50%; border: 3px solid #39b77c; object-fit: cover; margin-bottom: 8px;"
                         onerror="this.onerror=null; this.src='/img/mascotas/default.png';" />
                    <h4 style="margin: 0 0 5px 0; font-size: 1rem; font-weight: 600;">${nombreMostrar}</h4>
                    ${amigo.apodo ? `<p style="margin: 0 0 5px 0; font-size: 0.75rem; color: #999; font-style: italic;">(${amigo.nombre})</p>` : ''}
                    <p style="margin: 0; font-size: 0.85rem; color: #666;">üêæ ${amigo.mascotaNombre || 'Sin mascota'}</p>
                    <div style="display: flex; gap: 5px; margin-top: 8px; flex-direction: column;">
                        <button onclick="window.location.href='/Home/Perfil?id=${amigo.id}'" 
                                style="padding: 4px 8px; background: #39b77c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; width: 100%;">
                            üë§ Ver Perfil
                        </button>
                        <button onclick="editarApodo(${amigo.id}, '${(amigo.nombre || '').replace(/'/g, "\\'")}')" 
                                style="padding: 4px 8px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75rem; width: 100%;">
                            ‚úèÔ∏è Editar apodo
                        </button>
                    </div>
                </div>
            `);
            
            marker.bindPopup(popup);
            marcadoresAmigos[amigo.id] = marker;
        });
    });
}

function centrarEnAmigo(lat, lng) {
    if (lat != null && lng != null && !isNaN(lat) && !isNaN(lng)) {
        map.setView([lat, lng], 18);
    } else {
        mostrarMensaje("Este amigo no tiene ubicaci√≥n disponible", "error");
    }
}

function mostrarModalAmigo() {
    document.getElementById('modalAmigo').classList.add('activo');
    document.getElementById('inputEmailAmigo').focus();
}

function cerrarModalAmigo() {
    document.getElementById('modalAmigo').classList.remove('activo');
    document.getElementById('inputEmailAmigo').value = '';
}

function agregarAmigo() {
    const email = document.getElementById('inputEmailAmigo').value.trim();
    if (!email) {
        mostrarMensaje("Por favor ingres√° un email", "error");
        return;
    }
    
    fetch('/Home/AgregarAmigo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Amigo agregado correctamente", "exito");
            cerrarModalAmigo();
            cargarAmigos();
        } else {
            mostrarMensaje(data.message || "Error al agregar amigo", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al agregar amigo", "error");
    });
}

function mostrarMensaje(texto, tipo) {
    const mensaje = document.createElement('div');
    mensaje.className = `mensaje mensaje-${tipo}`;
    mensaje.textContent = texto;
    document.body.appendChild(mensaje);
    
    setTimeout(() => {
        mensaje.style.animation = 'slideDown 0.3s ease reverse';
        setTimeout(() => mensaje.remove(), 300);
    }, 3000);
}

// Cerrar modal al hacer clic fuera
document.getElementById('modalAmigo').addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalAmigo();
    }
});

function cargarSolicitudes() {
    fetch('/Home/ObtenerSolicitudes')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarSolicitudes(data.solicitudes);
            } else {
                document.getElementById('listaSolicitudes').innerHTML = 
                    '<p style="text-align: center; opacity: 0.7; color: inherit;">Error al cargar solicitudes</p>';
            }
        })
        .catch(err => {
            console.error('Error al cargar solicitudes:', err);
            document.getElementById('listaSolicitudes').innerHTML = 
                '<p style="text-align: center; opacity: 0.7; color: inherit;">Error al cargar solicitudes</p>';
        });
}

function mostrarSolicitudes(solicitudes) {
    const lista = document.getElementById('listaSolicitudes');
    if (!solicitudes || solicitudes.length === 0) {
        lista.innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit;">No ten√©s solicitudes pendientes</p>';
        return;
    }
    
    lista.innerHTML = solicitudes.map(solicitud => `
        <div class="usuario-item">
            <img src="${solicitud.fotoPerfil || '/img/perfil/default.png'}" alt="${solicitud.nombre}" class="amigo-avatar" />
            <div class="usuario-info">
                <p class="usuario-nombre">${solicitud.nombre}</p>
                <p class="usuario-email" style="font-size: 0.75rem; opacity: 0.7;">${solicitud.fecha}</p>
            </div>
            <div style="display: flex; gap: 5px;">
                <button class="btn-agregar-usuario" onclick="aceptarSolicitud(${solicitud.idInvitacion})" style="background: #39b77c;">‚úì</button>
                <button class="btn-agregar-usuario" onclick="rechazarSolicitud(${solicitud.idInvitacion})" style="background: #e74c3c;">‚úó</button>
            </div>
        </div>
    `).join('');
}

function aceptarSolicitud(invitacionId) {
    fetch('/Home/AceptarSolicitud', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ invitacionId: invitacionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Solicitud aceptada", "exito");
            cargarSolicitudes();
            cargarAmigos();
        } else {
            mostrarMensaje(data.message || "Error al aceptar solicitud", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al aceptar solicitud", "error");
    });
}

function rechazarSolicitud(invitacionId) {
    fetch('/Home/RechazarSolicitud', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ invitacionId: invitacionId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Solicitud rechazada", "exito");
            cargarSolicitudes();
        } else {
            mostrarMensaje(data.message || "Error al rechazar solicitud", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al rechazar solicitud", "error");
    });
}

function abrirChat(amigoId) {
    // Redirigir a la p√°gina de mensajes con el ID del amigo
    window.location.href = `/Home/Mensajes?amigoId=${amigoId}`;
}

function cambiarEstadoUbicacion() {
    const select = document.getElementById('selectUbicacion');
    const estado = select.value;
    
    fetch('/Home/ActualizarUbicacionMostrable', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ estado: estado })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const mensajes = {
                'nadie': 'Tu ubicaci√≥n ahora es privada',
                'amigos': 'Tu ubicaci√≥n ahora es visible solo para tus amigos',
                'todos': 'Tu ubicaci√≥n ahora es visible para todos los usuarios'
            };
            mostrarMensaje(mensajes[estado] || "Configuraci√≥n actualizada", "exito");
            cargarAmigos(); // Recargar amigos para actualizar visibilidad
        } else {
            mostrarMensaje("Error al actualizar configuraci√≥n", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al actualizar configuraci√≥n", "error");
    });
}

function cargarEstadoUbicacionMostrable() {
    fetch('/Home/ObtenerEstadoUbicacionMostrable')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('selectUbicacion');
                if (select) {
                    select.value = data.estado || 'amigos';
                }
            }
        })
        .catch(err => console.error('Error al cargar estado:', err));
}

function editarApodo(amigoId, nombreOriginal) {
    const apodoActual = prompt(`Ingres√° un apodo para ${nombreOriginal}:`, '');
    if (apodoActual === null) return; // Usuario cancel√≥
    
    fetch('/Home/ActualizarApodoAmigo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ amigoId: amigoId, apodo: apodoActual.trim() })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Apodo actualizado", "exito");
            cargarAmigos(); // Recargar para ver el cambio
        } else {
            mostrarMensaje(data.message || "Error al actualizar apodo", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al actualizar apodo", "error");
    });
}

function cargarPuntosInteres() {
    // Cargar veterinarias desde el JSON o base de datos
    fetch('/data/veterinarios.json')
        .then(response => response.json())
        .then(data => {
            if (data && data.veterinarios) {
                data.veterinarios.forEach(vet => {
                    const lat = vet.lat || vet.latitud;
                    const lng = vet.lng || vet.longitud;
                    const nombre = vet.nombre || vet.clinica || 'Veterinaria';
                    
                    if (lat && lng) {
                        // Icono para veterinaria (m√°s grande)
                        const iconoVet = L.divIcon({
                            className: 'punto-interes-marker',
                            html: '<div style="background: #e74c3c; width: 40px; height: 40px; border-radius: 50%; border: 4px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 22px;">üè•</div>',
                            iconSize: [40, 40],
                            iconAnchor: [20, 20]
                        });
                        
                        const marker = L.marker([parseFloat(lat), parseFloat(lng)], {
                            icon: iconoVet,
                            title: nombre
                        }).addTo(map);
                        
                        const popup = L.popup({
                            maxWidth: 250
                        }).setContent(`
                            <div style="padding: 8px;">
                                <h4 style="margin: 0 0 8px 0; font-size: 1rem; font-weight: 600;">${nombre}</h4>
                                ${vet.direccion ? `<p style="margin: 0 0 5px 0; font-size: 0.85rem; color: #666;">üìç ${vet.direccion}</p>` : ''}
                                ${vet.telefono ? `<p style="margin: 0 0 5px 0; font-size: 0.85rem; color: #666;">üìû ${vet.telefono}</p>` : ''}
                                ${vet.especialidad ? `<p style="margin: 0 0 5px 0; font-size: 0.85rem; color: #666;">‚öïÔ∏è ${vet.especialidad}</p>` : ''}
                                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(lat + ',' + lng)}" 
                                   target="_blank" 
                                   style="display: inline-block; margin-top: 8px; padding: 6px 12px; background: #39b77c; color: white; text-decoration: none; border-radius: 5px; font-size: 0.85rem; font-weight: 600; cursor: pointer;">
                                    Ver en Google Maps
                                </a>
                            </div>
                        `);
                        
                        marker.bindPopup(popup);
                    }
                });
            }
        })
        .catch(err => {
            console.error('Error al cargar puntos de inter√©s:', err);
        });
}

// ============================
// Funciones para carteles
// ============================
function cargarCarteles() {
    fetch('/Home/ObtenerCarteles')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remover marcadores antiguos
                Object.values(marcadoresCarteles).forEach(marker => map.removeLayer(marker));
                marcadoresCarteles = {};
                
                // Agregar nuevos marcadores
                data.carteles.forEach(cartel => {
                    const iconoColor = cartel.tipo === 'Perdida' ? '#e74c3c' : '#27ae60';
                    const iconoEmoji = cartel.tipo === 'Perdida' ? 'üî¥' : 'üü¢';
                    
                    const iconoCartel = L.divIcon({
                        className: 'cartel-marker',
                        html: `<div style="background: ${iconoColor}; width: 35px; height: 35px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 18px;">${iconoEmoji}</div>`,
                        iconSize: [35, 35],
                        iconAnchor: [17.5, 17.5]
                    });
                    
                    const marker = L.marker([parseFloat(cartel.lat), parseFloat(cartel.lng)], {
                        icon: iconoCartel,
                        title: `${cartel.tipo}: ${cartel.nombreMascota || 'Mascota'}`
                    }).addTo(map);
                    
                    const popupContent = `
                        <div style="padding: 8px; max-width: 300px;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 20px;">${iconoEmoji}</span>
                                <h4 style="margin: 0; font-size: 1rem; font-weight: 600;">${cartel.tipo === 'Perdida' ? 'Mascota Perdida' : 'Mascota Encontrada'}</h4>
                            </div>
                            ${cartel.fotoCartel ? `<img src="${cartel.fotoCartel}" alt="Foto" style="width: 100%; max-height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;" />` : ''}
                            ${cartel.nombreMascota ? `<p style="margin: 0 0 5px 0; font-size: 0.9rem; font-weight: 600;">üêæ ${cartel.nombreMascota}</p>` : ''}
                            ${cartel.especieMascota ? `<p style="margin: 0 0 3px 0; font-size: 0.85rem; color: #666;">${cartel.especieMascota}${cartel.razaMascota ? ` - ${cartel.razaMascota}` : ''}</p>` : ''}
                            ${cartel.descripcion ? `<p style="margin: 0 0 8px 0; font-size: 0.85rem; color: #666;">${cartel.descripcion}</p>` : ''}
                            <p style="margin: 0 0 5px 0; font-size: 0.85rem;"><strong>üìû Contacto:</strong> ${cartel.telefono}</p>
                            <p style="margin: 0 0 8px 0; font-size: 0.75rem; color: #999;">Publicado por: ${cartel.nombreUsuario}</p>
                            <p style="margin: 0 0 8px 0; font-size: 0.75rem; color: #999;">${cartel.fechaCreacion}</p>
                            ${cartel.esMio ? `<button onclick="eliminarCartel(${cartel.id})" style="width: 100%; padding: 6px; background: #e74c3c; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; margin-top: 5px;">üóëÔ∏è Eliminar Cartel</button>` : ''}
                        </div>
                    `;
                    
                    const popup = L.popup({
                        maxWidth: 300
                    }).setContent(popupContent);
                    
                    marker.bindPopup(popup);
                    marcadoresCarteles[cartel.id] = marker;
                });
            }
        })
        .catch(err => {
            console.error('Error al cargar carteles:', err);
        });
}

function activarModoCrearCartel() {
    mostrarMensaje("Hac√© doble clic en el mapa donde quer√©s crear el cartel", "exito");
    // Cargar mascotas del usuario
    cargarMascotasParaCartel();
}

function cargarMascotasParaCartel() {
    fetch('/Home/ObtenerMascotas')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('selectMascotaCartel');
                select.innerHTML = '<option value="">Ninguna (mascota gen√©rica)</option>';
                
                // Filtrar mascotas duplicadas por raza y nombre
                const mascotasUnicas = [];
                const mascotasVistas = new Set();
                
                data.mascotas.forEach(mascota => {
                    const clave = `${mascota.nombre.toLowerCase()}_${(mascota.raza || '').toLowerCase()}`;
                    if (!mascotasVistas.has(clave)) {
                        mascotasVistas.add(clave);
                        mascotasUnicas.push(mascota);
                    }
                });
                
                mascotasUnicas.forEach(mascota => {
                    const option = document.createElement('option');
                    option.value = mascota.id;
                    const razaTexto = mascota.raza ? ` - ${mascota.raza}` : '';
                    option.textContent = `${mascota.nombre} (${mascota.especie}${razaTexto})`;
                    option.dataset.raza = mascota.raza || '';
                    select.appendChild(option);
                });
            }
        })
        .catch(err => {
            console.error('Error al cargar mascotas:', err);
        });
}

function mostrarModalCrearCartel(lat, lng) {
    modalCartelLat = lat;
    modalCartelLng = lng;
    document.getElementById('modalCartel').classList.add('activo');
    cargarMascotasParaCartel();
}

function cerrarModalCartel() {
    document.getElementById('modalCartel').classList.remove('activo');
    document.getElementById('selectTipoCartel').value = 'Perdida';
    document.getElementById('selectMascotaCartel').value = '';
    document.getElementById('textareaDescripcionCartel').value = '';
    document.getElementById('inputTelefonoCartel').value = '';
    const fotoInput = document.getElementById('inputFotoCartel');
    if (fotoInput) fotoInput.value = '';
    modalCartelLat = null;
    modalCartelLng = null;
}

function crearCartel() {
    const tipo = document.getElementById('selectTipoCartel').value;
    const idMascotaSelect = document.getElementById('selectMascotaCartel');
    const idMascota = idMascotaSelect.value;
    const descripcion = document.getElementById('textareaDescripcionCartel').value.trim();
    const telefono = document.getElementById('inputTelefonoCartel').value.trim();
    const fotoInput = document.getElementById('inputFotoCartel');
    
    if (!telefono) {
        mostrarMensaje("El tel√©fono de contacto es requerido", "error");
        return;
    }
    
    if (!modalCartelLat || !modalCartelLng) {
        mostrarMensaje("Error: no se pudo obtener la ubicaci√≥n", "error");
        return;
    }
    
    // Validar que latitud y longitud sean n√∫meros
    const latitud = parseFloat(modalCartelLat);
    const longitud = parseFloat(modalCartelLng);
    
    if (isNaN(latitud) || isNaN(longitud)) {
        mostrarMensaje("Error: coordenadas inv√°lidas", "error");
        return;
    }
    
    // Siempre usar FormData para mantener consistencia
    const formData = new FormData();
    formData.append('tipo', tipo);
    formData.append('latitud', latitud.toString());
    formData.append('longitud', longitud.toString());
    formData.append('descripcion', descripcion);
    formData.append('telefono', telefono);
    formData.append('idMascota', idMascota || '');
    
    // Agregar foto si existe
    if (fotoInput && fotoInput.files && fotoInput.files.length > 0) {
        formData.append('foto', fotoInput.files[0]);
    }
    
    fetch('/Home/CrearCartel', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Cartel creado exitosamente", "exito");
            cerrarModalCartel();
            cargarCarteles();
        } else {
            mostrarMensaje(data.message || "Error al crear cartel", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al crear cartel", "error");
    });
}

function eliminarCartel(idCartel) {
    if (!confirm("¬øEst√°s seguro de que quer√©s eliminar este cartel?")) {
        return;
    }
    
    fetch('/Home/EliminarCartel', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ idCartel: idCartel })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            mostrarMensaje("Cartel eliminado exitosamente", "exito");
            cargarCarteles();
        } else {
            mostrarMensaje(data.message || "Error al eliminar cartel", "error");
        }
    })
    .catch(err => {
        console.error('Error:', err);
        mostrarMensaje("Error al eliminar cartel", "error");
    });
}

// Cerrar modal al hacer clic fuera
document.getElementById('modalCartel')?.addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalCartel();
    }
});

// ============================
// Funciones para proveedores
// ============================
function cargarProveedores() {
    fetch('/Home/ObtenerProveedoresParaComunidad')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarProveedores(data.proveedores);
                actualizarMarcadoresProveedores(data.proveedores);
            } else {
                document.getElementById('listaProveedores').innerHTML = 
                    '<p style="text-align: center; opacity: 0.7; color: inherit; padding: 20px;">Error al cargar servicios</p>';
            }
        })
        .catch(err => {
            console.error('Error al cargar servicios:', err);
            document.getElementById('listaProveedores').innerHTML = 
                '<p style="text-align: center; opacity: 0.7; color: inherit; padding: 20px;">Error al cargar servicios</p>';
        });
}

let todosLosProveedores = [];

function mostrarProveedores(proveedores) {
    todosLosProveedores = proveedores;
    const lista = document.getElementById('listaProveedores');
    if (!proveedores || proveedores.length === 0) {
        lista.innerHTML = '<p style="text-align: center; opacity: 0.7; color: inherit; padding: 20px;">No hay servicios disponibles en este momento</p>';
        return;
    }
    
    renderizarProveedores(proveedores);
}

function renderizarProveedores(proveedores) {
    const lista = document.getElementById('listaProveedores');
    lista.innerHTML = proveedores.map(prov => {
        const distanciaTexto = prov.distanciaKm != null 
            ? (prov.distanciaKm < 1 ? `${(prov.distanciaKm * 1000).toFixed(0)} m` : `${prov.distanciaKm.toFixed(1)} km`)
            : '';
        const precioTexto = prov.precioHora != null ? `$${prov.precioHora.toFixed(2)}/hora` : 'Consultar precio';
        const calificacionTexto = prov.calificacion != null ? `‚≠ê ${prov.calificacion.toFixed(1)}` : 'Sin calificaci√≥n';
        const tiposTexto = prov.tiposServicio && prov.tiposServicio.length > 0 
            ? prov.tiposServicio.join(', ') 
            : 'Servicios varios';
        const tipoIcono = prov.tipoUbicacion === 'Cobertura' ? 'üêæ' : 'üè†';
        
        return `
        <div class="servicio-card" data-nombre="${prov.nombreCompleto.toLowerCase()}" data-servicios="${tiposTexto.toLowerCase()}" 
             onclick="seleccionarProveedor(${prov.id}, ${prov.lat}, ${prov.lng}, ${prov.radioAtencionKm || 5}, '${prov.tipoUbicacion || 'Cobertura'}')" 
             style="cursor: pointer; background: var(--card-claro); border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 2px solid transparent; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="display: flex; gap: 12px; align-items: flex-start;">
                <img src="${prov.fotoPerfil || '/img/perfil/default.png'}" alt="${prov.nombreCompleto}" 
                     style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid var(--verde); flex-shrink: 0;" 
                     onerror="this.src='/img/perfil/default.png'" />
                <div style="flex: 1; min-width: 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px;">
                        <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: inherit;">${prov.nombreCompleto}</h4>
                        <span style="font-size: 1.2rem;">${tipoIcono}</span>
                    </div>
                    <p style="margin: 0 0 6px 0; font-size: 0.85rem; color: var(--verde); font-weight: 500;">${tiposTexto}</p>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 8px;">
                        <span style="font-size: 0.8rem; color: inherit; opacity: 0.8;">${calificacionTexto} ${prov.cantidadResenas > 0 ? `(${prov.cantidadResenas})` : ''}</span>
                        ${distanciaTexto ? `<span style="font-size: 0.8rem; color: inherit; opacity: 0.8;">üìç ${distanciaTexto}</span>` : ''}
                        <span style="font-size: 0.85rem; font-weight: 600; color: var(--verde);">${precioTexto}</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 8px;">
                        <button onclick="event.stopPropagation(); window.location.href='/Home/PerfilProveedor/${prov.id}'" 
                                style="flex: 1; padding: 8px 12px; background: var(--verde); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;">
                            üë§ Ver Perfil
                        </button>
                        <button onclick="event.stopPropagation(); mostrarModalContratar(${prov.id}, '${prov.nombreCompleto.replace(/'/g, "\\'")}', ${prov.precioHora || 0})" 
                                style="flex: 1; padding: 8px 12px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s;">
                            üìÖ Contratar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `}).join('');
    
    // Agregar estilos hover
    document.querySelectorAll('.servicio-card').forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.borderColor = 'var(--verde)';
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.borderColor = 'transparent';
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        });
    });
}

function filtrarServicios(termino) {
    if (!termino || termino.trim() === '') {
        renderizarProveedores(todosLosProveedores);
        return;
    }
    
    const terminoLower = termino.toLowerCase();
    const filtrados = todosLosProveedores.filter(prov => {
        const nombre = prov.nombreCompleto.toLowerCase();
        const servicios = prov.tiposServicio ? prov.tiposServicio.join(' ').toLowerCase() : '';
        return nombre.includes(terminoLower) || servicios.includes(terminoLower);
    });
    
    renderizarProveedores(filtrados);
}

function actualizarMarcadoresProveedores(proveedores) {
    // Remover marcadores antiguos
    Object.values(marcadoresProveedores).forEach(marker => map.removeLayer(marker));
    marcadoresProveedores = {};
    
    if (!proveedores || proveedores.length === 0) return;
    
    proveedores.forEach(prov => {
        if (prov.lat && prov.lng) {
            const iconoProveedor = L.divIcon({
                className: 'proveedor-marker',
                html: `<div style="background: #8B5E3C; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 16px;">üîß</div>`,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });
            
            const marker = L.marker([prov.lat, prov.lng], {
                icon: iconoProveedor,
                title: prov.nombreCompleto
            }).addTo(map);
            
            const popup = L.popup({
                maxWidth: 250
            }).setContent(`
                <div style="padding: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 1rem; font-weight: 600;">${prov.nombreCompleto}</h4>
                    ${prov.tiposServicio && prov.tiposServicio.length > 0 ? `<p style="margin: 0 0 5px 0; font-size: 0.85rem; color: #666;">üîß ${prov.tiposServicio.join(', ')}</p>` : ''}
                    ${prov.calificacion != null ? `<p style="margin: 0 0 5px 0; font-size: 0.85rem; color: #666;">‚≠ê ${prov.calificacion.toFixed(1)} ${prov.cantidadResenas > 0 ? `(${prov.cantidadResenas} rese√±as)` : ''}</p>` : ''}
                    ${prov.precioHora != null ? `<p style="margin: 0 0 5px 0; font-size: 0.85rem; color: #666; font-weight: 600; color: var(--verde);">$${prov.precioHora.toFixed(2)}/hora</p>` : ''}
                    ${prov.distanciaKm != null ? `<p style="margin: 0 0 8px 0; font-size: 0.85rem; color: #666;">üìç A ${prov.distanciaKm < 1 ? (prov.distanciaKm * 1000).toFixed(0) + ' m' : prov.distanciaKm.toFixed(1) + ' km'}</p>` : ''}
                    <div style="display: flex; gap: 5px; flex-direction: column;">
                        <button onclick="window.location.href='/Home/PerfilProveedor/${prov.id}'" 
                                style="padding: 6px 12px; background: var(--verde); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; width: 100%;">
                            üë§ Ver Perfil
                        </button>
                        <button onclick="seleccionarProveedor(${prov.id}, ${prov.lat}, ${prov.lng}, ${prov.radioAtencionKm || 5}, '${prov.tipoUbicacion || 'Cobertura'}')" 
                                style="padding: 6px 12px; background: #8B5E3C; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; width: 100%;">
                            üìç Ver Zona
                        </button>
                        <button onclick="mostrarModalContratar(${prov.id}, '${prov.nombreCompleto.replace(/'/g, "\\'")}', ${prov.precioHora || 0})" 
                                style="padding: 6px 12px; background: #3498db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; width: 100%;">
                            üìÖ Contratar
                        </button>
                    </div>
                </div>
            `);
            
            marker.bindPopup(popup);
            marker.on('click', function() {
                seleccionarProveedor(prov.id, prov.lat, prov.lng, prov.radioAtencionKm || 5, prov.tipoUbicacion || 'Cobertura');
            });
            
            marcadoresProveedores[prov.id] = marker;
        }
    });
}

function seleccionarProveedor(id, lat, lng, radioKm, tipoUbicacion) {
    // Remover c√≠rculo anterior si existe
    if (circuloProveedor) {
        map.removeLayer(circuloProveedor);
        circuloProveedor = null;
    }
    
    // Si es el mismo proveedor, deseleccionar
    if (proveedorSeleccionado === id) {
        proveedorSeleccionado = null;
        map.closePopup();
        return;
    }
    
    proveedorSeleccionado = id;
    
    // Centrar mapa en el proveedor
    map.setView([lat, lng], 14);
    
    // Crear c√≠rculo de zona de atenci√≥n
    const radioMetros = radioKm * 1000;
    const color = tipoUbicacion === 'Cobertura' ? '#8B5E3C' : '#3498db';
    
    circuloProveedor = L.circle([lat, lng], {
        radius: radioMetros,
        color: color,
        fillColor: color,
        fillOpacity: 0.2,
        weight: 3
    }).addTo(map);
    
    // Abrir popup del marcador
    if (marcadoresProveedores[id]) {
        marcadoresProveedores[id].openPopup();
    }
    
    // Scroll al proveedor en la lista
    const lista = document.getElementById('listaProveedores');
    const items = lista.querySelectorAll('.usuario-item');
    items.forEach((item, index) => {
        if (item.onclick && item.onclick.toString().includes(`seleccionarProveedor(${id}`)) {
            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
            item.style.background = 'var(--amarillo)';
            setTimeout(() => {
                item.style.background = '';
            }, 2000);
        }
    });
}

// Modal de contrataci√≥n r√°pida
let proveedorActualContratar = null;
let mascotasUsuario = [];

function mostrarModalContratar(idProveedor, nombreProveedor, precioHora, tiposServicio) {
    proveedorActualContratar = idProveedor;
    const modal = document.getElementById('modalContratar');
    const content = document.getElementById('modalContratarContent');
    
    // Cargar mascotas y tipos de servicio del proveedor
    Promise.all([
        fetch('/Home/ObtenerMascotas').then(r => r.json()),
        fetch(`/Home/ObtenerTiposServicio/${idProveedor}`).then(r => r.json())
    ])
        .then(([mascotasData, tiposData]) => {
            if (mascotasData.success) {
                mascotasUsuario = mascotasData.mascotas || [];
            }
            const tipos = tiposData.success ? tiposData.tipos : [];
            mostrarFormularioContratar(nombreProveedor, precioHora, tipos);
        })
        .catch(err => {
            console.error('Error:', err);
            content.innerHTML = '<p>Error al cargar datos</p>';
        });
    
    modal.classList.add('activo');
}

function mostrarFormularioContratar(nombreProveedor, precioHora, tiposServicio) {
    const content = document.getElementById('modalContratarContent');
    const tiposArray = Array.isArray(tiposServicio) ? tiposServicio : [];
    const tiposOptions = tiposArray.map(t => `<option value="${t.id || ''}">${t.descripcion || t}</option>`).join('');
    
    const mascotasOptions = mascotasUsuario.map(m => 
        `<option value="${m.id}">${m.nombre} (${m.especie})</option>`
    ).join('');
    
    const hoy = new Date().toISOString().split('T')[0];
    const ahora = new Date().toTimeString().slice(0, 5);
    
    content.innerHTML = `
        <div style="margin-bottom: 15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 8px;">
            <strong>${nombreProveedor}</strong>
            ${precioHora > 0 ? `<div style="color: var(--verde); font-weight: 600; margin-top: 5px;">$${precioHora.toFixed(2)}/hora</div>` : ''}
        </div>
        <form id="formContratarRapido" onsubmit="enviarContratacionRapida(event)">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">üêæ Mascota *</label>
                <select id="mascotaContratar" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                    <option value="">Seleccionar...</option>
                    ${mascotasOptions}
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">üîß Servicio *</label>
                <select id="tipoServicioContratar" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                    <option value="">Seleccionar...</option>
                    ${tiposOptions}
                </select>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">üìÖ Fecha *</label>
                    <input type="date" id="fechaContratar" required min="${hoy}" value="${hoy}" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;" />
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; font-size: 0.9rem;">üïê Hora *</label>
                    <input type="time" id="horaContratar" required value="${ahora}" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;" />
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">‚è±Ô∏è Duraci√≥n *</label>
                <select id="duracionContratar" required style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                    <option value="0.5">30 min</option>
                    <option value="1" selected>1 hora</option>
                    <option value="1.5">1.5 horas</option>
                    <option value="2">2 horas</option>
                    <option value="3">3 horas</option>
                    <option value="4">4 horas</option>
                </select>
            </div>
            <div style="display: flex; gap: 10px;">
                <button type="submit" class="btn-modal btn-primary" style="flex: 1;">‚úÖ Confirmar</button>
                <button type="button" class="btn-modal btn-secondary" onclick="cerrarModalContratar()" style="flex: 1;">Cancelar</button>
            </div>
        </form>
    `;
}

function cerrarModalContratar() {
    document.getElementById('modalContratar').classList.remove('activo');
    proveedorActualContratar = null;
}

async function enviarContratacionRapida(event) {
    event.preventDefault();
    
    if (!proveedorActualContratar) {
        mostrarMensaje('Error: Servicio no seleccionado', 'error');
        return;
    }
    
    // Obtener tipos de servicio del proveedor
    const tipoServicioSelect = document.getElementById('tipoServicioContratar');
    const tipoServicioId = tipoServicioSelect.value;
    
    if (!tipoServicioId) {
        mostrarMensaje('Seleccion√° un tipo de servicio', 'error');
        return;
    }
    
    const mascotaSelect = document.getElementById('mascotaContratar');
    const mascotaId = parseInt(mascotaSelect.value);
    const mascotaNombre = mascotaSelect.options[mascotaSelect.selectedIndex].text;
    const tipoServicioNombre = tipoServicioSelect.options[tipoServicioSelect.selectedIndex].text;
    const fecha = document.getElementById('fechaContratar').value;
    const hora = document.getElementById('horaContratar').value;
    const duracion = parseFloat(document.getElementById('duracionContratar').value);
    
    const formData = {
        idProveedor: proveedorActualContratar,
        idMascota: mascotaId,
        idTipoServicio: parseInt(tipoServicioId),
        fechaInicio: fecha,
        horaInicio: hora,
        duracionHoras: duracion,
        notas: ''
    };
    
    try {
        const response = await fetch('/Home/CrearReserva', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            // Enviar mensaje autom√°tico con los datos de la reserva
            await enviarMensajeReserva(proveedorActualContratar, mascotaNombre, tipoServicioNombre, fecha, hora, duracion);
            
            mostrarMensaje('¬°Servicio contratado exitosamente! Se envi√≥ un mensaje al proveedor con los detalles.', 'exito');
            cerrarModalContratar();
            
            // Opcional: redirigir a mensajes despu√©s de 2 segundos
            setTimeout(() => {
                if (confirm('¬øQuer√©s ver la conversaci√≥n con el proveedor?')) {
                    // Obtener el Id_User del proveedor
                    const proveedor = todosLosProveedores.find(p => p.id === proveedorActualContratar);
                    if (proveedor && proveedor.idUser) {
                        window.location.href = `/Home/Mensajes?amigoId=${proveedor.idUser}`;
                    }
                }
            }, 2000);
        } else {
            mostrarMensaje(data.message || 'Error al contratar servicio', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        mostrarMensaje('Error al contratar servicio', 'error');
    }
}

async function enviarMensajeReserva(idProveedor, mascotaNombre, tipoServicio, fecha, hora, duracion) {
    try {
        // Obtener el Id_User del proveedor desde los datos ya cargados
        const proveedor = todosLosProveedores.find(p => p.id === idProveedor);
        if (!proveedor || !proveedor.idUser) {
            // Si no est√° en cache, obtenerlo
            const userProvResponse = await fetch(`/Home/ObtenerUserIdProveedor/${idProveedor}`);
            const userProvData = await userProvResponse.json();
            if (!userProvData.success) return;
            var idProveedorUser = userProvData.userId;
        } else {
            var idProveedorUser = proveedor.idUser;
        }
        
        // Obtener o crear chat
        const chatResponse = await fetch('/Home/ObtenerOCrearChatProveedor', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(idProveedorUser)
        });
        
        const chatData = await chatResponse.json();
        if (!chatData.success || !chatData.chatId) return;
        
        // Formatear fecha y hora
        const fechaObj = new Date(fecha);
        const fechaFormateada = fechaObj.toLocaleDateString('es-AR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        const horaFormateada = hora.substring(0, 5);
        const duracionTexto = duracion === 0.5 ? '30 minutos' : duracion === 1 ? '1 hora' : `${duracion} horas`;
        
        // Crear mensaje con los datos de la reserva
        const mensaje = `¬°Hola! Acabo de contratar tu servicio de ${tipoServicio} para mi mascota ${mascotaNombre}.

üìÖ Fecha: ${fechaFormateada}
üïê Hora: ${horaFormateada}
‚è±Ô∏è Duraci√≥n: ${duracionTexto}

Por favor confirmame si est√°s disponible en ese horario. ¬°Gracias!`;
        
        // Enviar mensaje
        await fetch('/Home/EnviarMensaje', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chatId: chatData.chatId,
                contenido: mensaje
            })
        });
    } catch (error) {
        console.error('Error al enviar mensaje de reserva:', error);
        // No mostramos error al usuario porque la reserva ya se cre√≥
    }
}

// Cerrar modal al hacer clic fuera
document.getElementById('modalContratar')?.addEventListener('click', function(e) {
    if (e.target === this) {
        cerrarModalContratar();
    }
});
</script>
</body>
</html>

