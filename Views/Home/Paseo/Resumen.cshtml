@{
    ViewData["Title"] = "Resumen de Paseo - Zooni";
    Layout = null;
    var reserva = ViewBag.Reserva;
    var distanciaTotal = reserva?["Distancia_Total_Metros"] != null && reserva["Distancia_Total_Metros"] != DBNull.Value 
        ? Convert.ToDecimal(reserva["Distancia_Total_Metros"]) : 0;
    var tiempoTotal = reserva?["Tiempo_Total_Segundos"] != null && reserva["Tiempo_Total_Segundos"] != DBNull.Value 
        ? Convert.ToInt32(reserva["Tiempo_Total_Segundos"]) : 0;
    var horas = tiempoTotal / 3600;
    var minutos = (tiempoTotal % 3600) / 60;
    var segundos = tiempoTotal % 60;
    var tiempoTexto = $"{horas:D2}:{minutos:D2}:{segundos:D2}";
    var distanciaTexto = distanciaTotal < 1000 ? $"{Math.Round(distanciaTotal)} m" : $"{(distanciaTotal / 1000):F2} km";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: #f5f5f5; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .header h1 { color: #8B5E3C; margin-bottom: 10px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .stat-label { color: #666; font-size: 14px; margin-bottom: 10px; }
        .stat-value { color: #8B5E3C; font-size: 32px; font-weight: 700; }
        .map-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        #map { width: 100%; height: 400px; border-radius: 8px; }
        .actions { display: flex; gap: 15px; flex-wrap: wrap; }
        .btn { padding: 15px 30px; border: none; border-radius: 25px; font-weight: 600; font-size: 16px; cursor: pointer; text-decoration: none; display: inline-block; transition: all 0.3s; }
        .btn-compartir { background: #4A90E2; color: white; }
        .btn-compartir:hover { background: #357abd; }
        .btn-resenar { background: #3ac37d; color: white; }
        .btn-resenar:hover { background: #2ea968; }
        .btn-volver { background: #6c757d; color: white; }
        .btn-volver:hover { background: #5a6268; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; }
        .modal h2 { color: #8B5E3C; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: #666; font-weight: 600; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-family: 'Poppins', sans-serif; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .stars { display: flex; gap: 10px; margin: 10px 0; }
        .star { font-size: 30px; cursor: pointer; color: #ddd; }
        .star.active { color: #FFD700; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Resumen del Paseo</h1>
            <p style="color: #666;">@(reserva?["MascotaNombre"]) con @(reserva?["ProveedorNombre"])</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">‚è±Ô∏è Tiempo Total</div>
                <div class="stat-value">@tiempoTexto</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üìè Distancia Recorrida</div>
                <div class="stat-value">@distanciaTexto</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">üìÖ Fecha</div>
                <div class="stat-value" style="font-size: 18px;">@(reserva?["Fecha_Inicio"] != null ? Convert.ToDateTime(reserva["Fecha_Inicio"]).ToString("dd/MM/yyyy") : "")</div>
            </div>
        </div>

        <div class="map-container">
            <h2 style="color: #8B5E3C; margin-bottom: 15px;">üìç Ruta Recorrida</h2>
            <div id="map"></div>
        </div>

        <div class="actions">
            <button class="btn btn-compartir" onclick="compartirResumen()">üì§ Compartir Resumen</button>
            <button class="btn btn-resenar" onclick="mostrarModalResena()">‚≠ê Rese√±ar Paseador</button>
            <a href="/Home/Index" class="btn btn-volver">‚Üê Volver al Inicio</a>
        </div>
    </div>

    <!-- Modal de Rese√±a -->
    <div class="modal" id="modalResena">
        <div class="modal-content">
            <h2>‚≠ê Rese√±ar Paseador</h2>
            <form id="formResena" onsubmit="enviarResena(event)">
                <div class="form-group">
                    <label>Calificaci√≥n</label>
                    <div class="stars" id="stars">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                    <input type="hidden" id="calificacion" name="calificacion" value="0" required />
                </div>
                <div class="form-group">
                    <label>Comentario</label>
                    <textarea name="comentario" placeholder="Contanos sobre tu experiencia..." required></textarea>
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn btn-volver" onclick="cerrarModalResena()">Cancelar</button>
                    <button type="submit" class="btn btn-resenar">Enviar Rese√±a</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let map;
        let polyline;
        const idReserva = @ViewBag.IdReserva;
        const idProveedor = @(reserva?["Id_Proveedor"] ?? 0);
        let calificacionSeleccionada = 0;

        function initMap() {
            map = L.map('map').setView([-34.6037, -58.3816], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            cargarRuta();
        }

        function cargarRuta() {
            fetch(`/Home/Paseo/ObtenerRuta/${idReserva}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.puntos.length > 0) {
                        const puntos = data.puntos.map(p => [p.lat, p.lng]);
                        polyline = L.polyline(puntos, { color: '#4A90E2', weight: 5, opacity: 0.7 }).addTo(map);
                        map.fitBounds(polyline.getBounds());
                    }
                });
        }

        function compartirResumen() {
            const texto = `¬°Comparto el resumen de mi paseo con @(reserva?["ProveedorNombre"])!\n\n‚è±Ô∏è Tiempo: @tiempoTexto\nüìè Distancia: @distanciaTexto\n\n#Zooni #PaseoDeMascotas`;
            const url = window.location.href;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Resumen de Paseo - Zooni',
                    text: texto,
                    url: url
                }).catch(() => {
                    copiarAlPortapapeles(texto + '\n' + url);
                });
            } else {
                copiarAlPortapapeles(texto + '\n' + url);
            }
        }

        function copiarAlPortapapeles(texto) {
            navigator.clipboard.writeText(texto).then(() => {
                alert('‚úÖ Resumen copiado al portapapeles');
            });
        }

        function mostrarModalResena() {
            document.getElementById('modalResena').style.display = 'flex';
        }

        function cerrarModalResena() {
            document.getElementById('modalResena').style.display = 'none';
        }

        // Sistema de estrellas
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                const rating = parseInt(this.dataset.rating);
                calificacionSeleccionada = rating;
                document.getElementById('calificacion').value = rating;
                
                document.querySelectorAll('.star').forEach((s, i) => {
                    if (i < rating) {
                        s.classList.add('active');
                    } else {
                        s.classList.remove('active');
                    }
                });
            });

            star.addEventListener('mouseenter', function() {
                const rating = parseInt(this.dataset.rating);
                document.querySelectorAll('.star').forEach((s, i) => {
                    if (i < rating) {
                        s.style.color = '#FFD700';
                    } else {
                        s.style.color = '#ddd';
                    }
                });
            });
        });

        document.getElementById('stars').addEventListener('mouseleave', function() {
            document.querySelectorAll('.star').forEach((s, i) => {
                if (i < calificacionSeleccionada) {
                    s.style.color = '#FFD700';
                } else {
                    s.style.color = '#ddd';
                }
            });
        });

        function enviarResena(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const calificacion = parseInt(formData.get('calificacion'));
            const comentario = formData.get('comentario');

            if (calificacion === 0) {
                alert('Por favor seleccion√° una calificaci√≥n');
                return;
            }

            fetch('/Home/CrearResena', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    idProveedor: idProveedor,
                    idReserva: idReserva,
                    calificacion: calificacion,
                    comentario: comentario
                })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('‚úÖ Rese√±a enviada exitosamente');
                    cerrarModalResena();
                } else {
                    alert('Error al enviar la rese√±a: ' + (data.message || 'Error desconocido'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error al enviar la rese√±a');
            });
        }

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>

