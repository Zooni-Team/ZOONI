@{
    ViewData["Title"] = "Planificador de Servicios - Zooni";
    Layout = null;
    var tema = ViewBag.Tema ?? Context.Session.GetString("Tema") ?? "claro";
}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>@ViewData["Title"]</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="~/css/global.css" />
    <style>
        :root {
            --verde: #3ac37d;
            --verde-hover: #2ea968;
            --amarillo: #FFD85A;
            --marron: #4B3B2B;
            --gris: #555;
            --gris-claro: #ccc;
            --fondo-claro: #f9f9f8;
            --fondo-oscuro: #121212;
            --texto-claro: #3c2a1b;
            --texto-oscuro: #ffffff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Poppins', sans-serif;
            transition: background .4s ease, color .4s ease;
            overflow-x: hidden;
            padding-top: 80px;
        }

        body.tema-claro {
            background: url('/img/fondos/bosque.png') center center / cover no-repeat fixed;
            color: var(--texto-claro);
        }

        body.tema-oscuro {
            background: url('/img/fondos/bosque.png') center center / cover no-repeat fixed;
            background-color: rgba(0, 0, 0, 0.5);
            background-blend-mode: overlay;
            filter: brightness(0.6);
            color: var(--texto-oscuro);
        }

        /* Header */
        header {
            position: fixed;
            top: 15px;
            left: 20px;
            z-index: 10;
            transition: opacity .3s ease, visibility .3s ease;
        }

        .menu-icon {
            width: 38px;
            height: 38px;
            cursor: pointer;
            transition: transform .25s ease, filter .3s ease;
            filter: brightness(0);
        }
        
        body.tema-oscuro .menu-icon {
            filter: brightness(0) invert(1);
        }

        .menu-icon:hover { transform: scale(1.1); }
        
        header h1 {
            display: none;
        }

        .btn-volver {
            background: none;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-volver img {
            width: 20px;
            height: 20px;
            display: block;
            filter: brightness(0);
            transition: transform 0.2s ease;
        }

        body.tema-oscuro .btn-volver img {
            filter: brightness(0) invert(1);
        }

        .btn-volver:hover { 
            transform: translateX(-3px); 
        }

        h1 {
            flex: 1;
            color: var(--marron);
            font-size: 1.3rem;
            margin: 0;
        }

        /* Menu lateral */
        .menu-lateral {
            position: fixed;
            top: 0;
            left: 0;
            transform: translateX(-100%);
            width: 240px;
            height: 100%;
            backdrop-filter: blur(12px);
            box-shadow: 4px 0 12px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            padding: 2.5rem 1.2rem;
            gap: 1rem;
            transition: transform 0.35s ease, background .4s ease, color .4s ease;
            z-index: 999;
            border-radius: 0 !important;
        }

        body.tema-claro .menu-lateral {
            background: rgba(255, 255, 255, 0.97);
        }

        body.tema-oscuro .menu-lateral {
            background: rgba(30, 30, 30, 0.97);
            box-shadow: 4px 0 12px rgba(0, 0, 0, 0.5);
        }

        .menu-lateral.abierto { 
            transform: translateX(0); 
        }

        .cerrar-menu {
            align-self: flex-end;
            font-size: 1.6rem;
            cursor: pointer;
            margin-bottom: 1.5rem;
            transition: transform 0.2s ease;
            color: inherit;
        }

        body.tema-claro .cerrar-menu {
            color: var(--marron);
        }

        body.tema-oscuro .cerrar-menu {
            color: #ffffff;
        }

        .cerrar-menu:hover {
            transform: scale(1.2);
        }

        .menu-lateral a {
            text-decoration: none;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 0.6rem 0.8rem;
            border-radius: 12px;
            transition: all .25s ease;
            color: inherit;
        }

        body.tema-claro .menu-lateral a {
            color: var(--marron);
        }

        body.tema-oscuro .menu-lateral a {
            color: #ffffff;
        }

        body.tema-claro .menu-lateral a:hover { 
            background: var(--amarillo);
            color: #3c2a00;
        }

        body.tema-oscuro .menu-lateral a:hover {
            background: var(--verde);
            color: #ffffff;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            opacity: 0;
            pointer-events: none;
            transition: opacity .3s ease;
            z-index: 998;
        }

        .overlay.activo {
            opacity: 1;
            pointer-events: auto;
        }

        /* Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: @(tema == "oscuro" ? "#1e1e1e" : "#ffffff");
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: background-color .4s ease;
        }

        .card h2 {
            color: var(--marron);
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .reserva-item, .proveedor-item {
            padding: 15px;
            border-left: 4px solid var(--verde);
            margin-bottom: 15px;
            background: @(tema == "oscuro" ? "#2a2a2a" : "#f8f9fa");
            border-radius: 8px;
            transition: background-color .4s ease;
        }

        .reserva-item.pendiente { border-left-color: #ffc107; }
        .reserva-item.confirmada { border-left-color: #17a2b8; }
        .reserva-item.en-curso { border-left-color: var(--verde); }
        .reserva-item.completada { border-left-color: #6c757d; }

        .proveedor-item {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .proveedor-item:hover {
            transform: translateX(5px);
        }

        .proveedor-foto {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--verde);
        }

        .proveedor-info {
            flex: 1;
        }

        .proveedor-nombre {
            font-weight: 600;
            color: var(--marron);
            margin-bottom: 5px;
        }

        .btn-nueva-reserva {
            background: var(--verde);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-family: 'Poppins', sans-serif;
            transition: background 0.2s;
        }

        .btn-nueva-reserva:hover {
            background: var(--verde-hover);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.activo {
            display: flex;
        }

        .modal-content {
            background: @(tema == "oscuro" ? "#1e1e1e" : "#ffffff");
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color .4s ease;
        }

        .modal-content h2 {
            color: var(--marron);
            margin-top: 0;
            margin-bottom: 20px;
        }

        .campo {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: @(tema == "oscuro" ? "var(--texto-oscuro)" : "var(--gris)");
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1.8px solid var(--gris-claro);
            font-family: 'Poppins', sans-serif;
            background: @(tema == "oscuro" ? "#2a2a2a" : "#ffffff");
            color: @(tema == "oscuro" ? "var(--texto-oscuro)" : "var(--texto-claro)");
            transition: background-color .4s ease, color .4s ease;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .btn-accion {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin-right: 10px;
            font-family: 'Poppins', sans-serif;
        }

        .btn-cancelar {
            background: #dc3545;
            color: white;
        }

        .btn-ver {
            background: var(--verde);
            color: white;
        }

        .btn-chat {
            background: #4A90E2;
            color: white;
        }

        .btn-accion:hover {
            opacity: 0.9;
        }

        @@media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="tema-@tema">
    <header>
        <img src="~/img/icons/hamburger.png" alt="Men√∫" class="menu-icon" id="abrirMenu" />
    </header>

@await Html.PartialAsync("_MenuLateral")

    <div class="container">
        <div class="grid">
            <div class="card">
                <h2>üìã Pr√≥ximas Reservas</h2>
                <div id="listaReservas">
                    @if (ViewBag.Reservas != null && ViewBag.Reservas.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow reserva in ViewBag.Reservas.Rows)
                        {
                            string estado = reserva["Estado"]?.ToString() ?? "Pendiente";
                            string estadoClass = estado.ToLower().Replace(" ", "-");
                            <div class="reserva-item @estadoClass">
                                <strong>@reserva["MascotaNombre"] (@reserva["MascotaEspecie"])</strong><br>
                                <span>@reserva["TipoServicio"]</span><br>
                                <span>üìÖ @Convert.ToDateTime(reserva["Fecha_Inicio"]).ToString("dd/MM/yyyy")</span><br>
                                <span>üïê @TimeSpan.Parse(reserva["Hora_Inicio"].ToString()).ToString(@"hh\:mm")</span><br>
                                <span>‚è±Ô∏è @reserva["Duracion_Horas"] horas</span><br>
                                <span>üí∞ $@reserva["Precio_Total"]</span><br>
                                <span>üë§ @reserva["ProveedorNombre"]</span><br>
                                <span>Estado: <strong>@estado</strong></span><br>
                                <div style="margin-top: 10px; display: flex; gap: 5px; flex-wrap: wrap;">
                                    @if (estado == "Pendiente" || estado == "Confirmada")
                                    {
                                        <button class="btn-accion btn-cancelar" onclick="cancelarReserva(@reserva["Id_Reserva"])">Cancelar</button>
                                    }
                                    @if (estado == "EnCurso")
                                    {
                                        <a href="/Home/Paseo/Tracking/@reserva["Id_Reserva"]" class="btn-accion btn-ver">Ver Tracking</a>
                                    }
                                    <button class="btn-accion btn-chat" onclick="iniciarChatProveedor(@reserva["Id_Proveedor"])">üí¨ Chat</button>
                                    <a href="/Home/PerfilProveedor/@reserva["Id_Proveedor"]" class="btn-accion btn-ver">Ver Perfil</a>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p>No ten√©s reservas programadas</p>
                    }
                </div>
                <button class="btn-nueva-reserva" onclick="mostrarModalNuevaReserva()">‚ûï Nueva Reserva</button>
            </div>

            <div class="card">
                <h2>‚≠ê Proveedores Favoritos</h2>
                <div id="listaFavoritos">
                    @if (ViewBag.Favoritos != null && ViewBag.Favoritos.Rows.Count > 0)
                    {
                        foreach (System.Data.DataRow favorito in ViewBag.Favoritos.Rows)
                        {
                            <div class="proveedor-item" onclick="window.location.href='/Home/PerfilProveedor/@favorito["Id_Proveedor"]'">
                                <img src="/img/perfil/default.png" alt="@favorito["NombreCompleto"]" class="proveedor-foto" onerror="this.src='/img/perfil/default.png'" />
                                <div class="proveedor-info">
                                    <div class="proveedor-nombre">@favorito["NombreCompleto"]</div>
                                    <div>üí∞ $@favorito["Precio_Hora"]/hora</div>
                                    <div>üìä @favorito["CantidadReservas"] reservas</div>
                                    @if (favorito["CalificacionPromedio"] != DBNull.Value)
                                    {
                                        <div>‚≠ê @Math.Round(Convert.ToDouble(favorito["CalificacionPromedio"]), 1)</div>
                                    }
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p>No ten√©s proveedores favoritos a√∫n</p>
                        <a href="/Home/Comunidad" class="btn-accion btn-ver" style="display: block; text-align: center; text-decoration: none; margin-top: 15px;">Ver Proveedores en Comunidad</a>
                    }
                </div>
            </div>

            <div class="card">
                <h2>üîç Proveedores Disponibles</h2>
                <div id="listaProveedores">
                    <p>Cargando proveedores...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nueva Reserva -->
    <div id="modalNuevaReserva" class="modal">
        <div class="modal-content">
            <h2>Nueva Reserva</h2>
            <form id="formNuevaReserva">
                <div class="campo">
                    <label>Proveedor *</label>
                    <select id="idProveedor" required>
                        <option value="">Seleccionar proveedor</option>
                    </select>
                </div>
                <div class="campo">
                    <label>Mascota *</label>
                    <select id="idMascota" required>
                        <option value="">Seleccionar mascota</option>
                        @if (ViewBag.Mascotas != null)
                        {
                            foreach (System.Data.DataRow mascota in ViewBag.Mascotas.Rows)
                            {
                                <option value="@mascota["Id_Mascota"]">@mascota["Nombre"] (@mascota["Especie"])</option>
                            }
                        }
                    </select>
                </div>
                <div class="campo">
                    <label>Tipo de Servicio *</label>
                    <select id="idTipoServicio" required disabled>
                        <option value="">Primero selecciona un proveedor</option>
                    </select>
                </div>
                <div class="campo">
                    <label>Fecha *</label>
                    <input type="date" id="fechaInicio" required min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                </div>
                <div class="campo">
                    <label>Hora *</label>
                    <input type="time" id="horaInicio" required />
                </div>
                <div class="campo">
                    <label>Duraci√≥n (horas) *</label>
                    <input type="number" id="duracionHoras" min="0.5" max="24" step="0.5" value="1" required />
                </div>
                <div class="campo">
                    <label>Direcci√≥n del Servicio (opcional)</label>
                    <input type="text" id="direccionServicio" placeholder="Direcci√≥n donde se realizar√° el servicio" />
                </div>
                <div class="campo">
                    <label>Notas (opcional)</label>
                    <textarea id="notas" placeholder="Instrucciones especiales, preferencias, etc."></textarea>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn-nueva-reserva" style="flex: 1; margin: 0;">Crear Reserva</button>
                    <button type="button" class="btn-accion btn-cancelar" onclick="cerrarModal()" style="flex: 1;">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Menu lateral
        const menu = document.getElementById("menuLateral");
        const overlay = document.getElementById("overlay");
        const abrir = document.getElementById("abrirMenu");
        const cerrar = document.getElementById("cerrarMenu");
        const header = document.querySelector("header");

        function cerrarMenu() {
            menu.classList.remove("abierto");
            overlay.classList.remove("activo");
        }

        abrir.addEventListener("click", (e) => {
            e.stopPropagation();
            menu.classList.add("abierto");
            overlay.classList.add("activo");
        });

        cerrar.addEventListener("click", cerrarMenu);
        overlay.addEventListener("click", cerrarMenu);

        // Cargar proveedores disponibles
        async function cargarProveedoresDisponibles() {
            try {
                const response = await fetch('/Home/ObtenerProveedores');
                const data = await response.json();
                const lista = document.getElementById('listaProveedores');
                
                if (data.success && data.proveedores && data.proveedores.length > 0) {
                    lista.innerHTML = '';
                    data.proveedores.slice(0, 5).forEach(prov => {
                        const item = document.createElement('div');
                        item.className = 'proveedor-item';
                        item.onclick = () => window.location.href = `/Home/PerfilProveedor/${prov.id}`;
                        item.innerHTML = `
                            <img src="${prov.fotoPerfil || '/img/perfil/default.png'}" alt="${prov.nombre}" class="proveedor-foto" onerror="this.src='/img/perfil/default.png'" />
                            <div class="proveedor-info">
                                <div class="proveedor-nombre">${prov.nombre}</div>
                                <div>üí∞ $${prov.precioHora || 'N/A'}/hora</div>
                                ${prov.calificacion ? `<div>‚≠ê ${prov.calificacion.toFixed(1)}</div>` : ''}
                            </div>
                        `;
                        lista.appendChild(item);
                    });
                } else {
                    lista.innerHTML = '<p>No hay proveedores disponibles</p>';
                }
            } catch (error) {
                console.error('Error al cargar proveedores:', error);
                document.getElementById('listaProveedores').innerHTML = '<p>Error al cargar proveedores</p>';
            }
        }

        // Cargar proveedores y tipos de servicio
        async function cargarProveedores() {
            try {
                const response = await fetch('/Home/ObtenerProveedores');
                const data = await response.json();
                if (data.success) {
                    const select = document.getElementById('idProveedor');
                    select.innerHTML = '<option value="">Seleccionar proveedor</option>';
                    data.proveedores.forEach(prov => {
                        const option = document.createElement('option');
                        option.value = prov.id;
                        option.textContent = `${prov.nombre} - $${prov.precioHora || 'N/A'}/hora`;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error al cargar proveedores:', error);
            }
        }

        document.getElementById('idProveedor')?.addEventListener('change', async function() {
            const idProveedor = this.value;
            const tipoSelect = document.getElementById('idTipoServicio');
            
            if (!idProveedor) {
                tipoSelect.innerHTML = '<option value="">Primero selecciona un proveedor</option>';
                tipoSelect.disabled = true;
                return;
            }

            try {
                const response = await fetch(`/Home/ObtenerTiposServicio/${idProveedor}`);
                const data = await response.json();
                if (data.success) {
                    tipoSelect.innerHTML = '<option value="">Seleccionar servicio</option>';
                    data.tipos.forEach(tipo => {
                        const option = document.createElement('option');
                        option.value = tipo.id;
                        option.textContent = tipo.descripcion;
                        tipoSelect.appendChild(option);
                    });
                    tipoSelect.disabled = false;
                } else {
                    tipoSelect.innerHTML = '<option value="">Error al cargar servicios</option>';
                    tipoSelect.disabled = true;
                }
            } catch (error) {
                console.error('Error al cargar tipos de servicio:', error);
                tipoSelect.innerHTML = '<option value="">Error al cargar servicios</option>';
                tipoSelect.disabled = true;
            }
        });

        function mostrarModalNuevaReserva() {
            document.getElementById('modalNuevaReserva').classList.add('activo');
            cargarProveedores();
        }

        function cerrarModal() {
            document.getElementById('modalNuevaReserva').classList.remove('activo');
            document.getElementById('formNuevaReserva').reset();
            document.getElementById('idTipoServicio').innerHTML = '<option value="">Primero selecciona un proveedor</option>';
            document.getElementById('idTipoServicio').disabled = true;
        }

        document.getElementById('formNuevaReserva')?.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                idProveedor: parseInt(document.getElementById('idProveedor').value),
                idMascota: parseInt(document.getElementById('idMascota').value),
                idTipoServicio: parseInt(document.getElementById('idTipoServicio').value),
                fechaInicio: document.getElementById('fechaInicio').value,
                horaInicio: document.getElementById('horaInicio').value,
                duracionHoras: parseFloat(document.getElementById('duracionHoras').value),
                direccionServicio: document.getElementById('direccionServicio').value,
                notas: document.getElementById('notas').value
            };

            try {
                const response = await fetch('/Home/CrearReserva', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('¬°Reserva creada exitosamente!');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'No se pudo crear la reserva'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al crear la reserva');
            }
        });

        async function cancelarReserva(idReserva) {
            if (!confirm('¬øEst√°s seguro de que quer√©s cancelar esta reserva?')) return;

            try {
                const response = await fetch('/Home/CancelarReserva', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idReserva: idReserva })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Reserva cancelada exitosamente');
                    location.reload();
                } else {
                    alert('Error: ' + (data.message || 'No se pudo cancelar la reserva'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al cancelar la reserva');
            }
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalNuevaReserva')?.addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });

        // Funci√≥n para iniciar chat con proveedor
        async function iniciarChatProveedor(idProveedor) {
            try {
                // Obtener Id_User del proveedor
                const response = await fetch(`/Home/ObtenerIdUserProveedor/${idProveedor}`);
                const data = await response.json();
                
                if (data.success && data.idUser) {
                    // Usar el mismo sistema de chat que los amigos
                    const chatResponse = await fetch('/Home/ObtenerOCrearChat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data.idUser)
                    });
                    
                    const chatData = await chatResponse.json();
                    if (chatData.success && chatData.chatId) {
                        window.location.href = `/Home/Mensajes?amigoId=${data.idUser}`;
                    } else {
                        alert(chatData.message || 'Error al iniciar el chat');
                    }
                } else {
                    alert('Error al obtener informaci√≥n del proveedor');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al iniciar el chat');
            }
        }

        // Cargar proveedores disponibles al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            cargarProveedoresDisponibles();
        });
    </script>
</body>
</html>
